import{Z as v,S as k,t as u,m as d,j as x,s as f,O as N,k as D,l as L}from"./kGF9pzg7.js";import{g as K}from"./Bz_gD2gR.js";import{g as X,k as q,b as Z}from"./B7hZ1RX6.js";const C="BarStack",V=Z(C,"g"),H=Z(C,"g-content"),_=.3;function J({axisWidth:g,groupAmount:o,barGroupPadding:n=0}){const s=g/(o-1)-n;return s>1?s:1}function Q(g,o){return g<=1?0:o/(g-1)*_}function ee(g,o){return g<=1?o:o*(1-_)}function re({selection:g,data:o,zeroY:n,groupLabels:i,params:s,chartParams:l,barWidth:$,transformedBarRadius:S,delayGroup:P,transitionItem:A}){const I=$/2;return g.selectAll(`g.${V}`).data(o,(c,y)=>i[y]).join(c=>c.append("g").classed(V,!0).attr("cursor","pointer"),c=>c,c=>c.remove()).attr("transform",(c,y)=>`translate(${c[0]?c[0].axisX:0}, 0)`).each((c,y,Y)=>{L(Y[y]).selectAll("g").data(c,b=>b.id).join(b=>b.append("g").classed(H,!0),b=>b,b=>b.remove()).each((b,M,F)=>{L(F[M]).selectAll("rect").data([b],p=>p.id).join(p=>p.append("rect").attr("y",G=>n).attr("height",G=>0),p=>p,p=>p.remove()).attr("rx",S[0]).attr("ry",S[1]).attr("fill",p=>p.color).attr("transform",`translate(${-I}, 0)`).attr("x",p=>0).attr("width",$).transition().duration(A).ease(q(l.transitionEase)).delay((p,G)=>p.groupIndex*P).attr("y",p=>p._barStartY).attr("height",p=>Math.abs(p._barHeight))})}).selectAll(`g.${H}`)}function ae({defsSelection:g,clipPathData:o}){g.selectAll("clipPath").data(o).join(n=>n.append("clipPath"),n=>n,n=>n.remove()).attr("id",n=>n.id).each((n,i,s)=>{L(s[i]).selectAll("rect").data([n]).join(l=>l.append("rect"),l=>l,l=>l.remove()).attr("x",0).attr("y",0).attr("width",l=>l.width).attr("height",l=>l.height)})}function te({selection:g,ids:o,fullChartParams:n}){if(g.interrupt("highlight"),!o.length){g.transition("highlight").duration(200).style("opacity",1);return}g.each((i,s,l)=>{o.includes(i.id)?L(l[s]).style("opacity",1):L(l[s]).style("opacity",n.styles.unhighlightedOpacity)})}const oe=v(C,K)(({selection:g,name:o,subject:n,observer:i})=>{const s=new k,l=X(C,"clipPath-box"),$=g.append("g").attr("clip-path",`url(#${l})`),S=$.append("defs"),P=$.append("g"),A=new k;i.gridAxesTransform$.pipe(u(s),d(e=>e.value),x()).subscribe(e=>{$.style("transform",e)}),i.gridGraphicTransform$.pipe(u(s),f(async e=>e.value),x()).subscribe(e=>{P.transition().duration(50).style("transform",e)});const I=i.visibleComputedData$.pipe(d(e=>e[0]&&e[0][0]?e[0][0].axisY-e[0][0].axisYFromZero:0),x()),w=new N(e=>{D({computedData:i.computedData$,params:i.fullParams$,axisSize:i.gridAxesSize$}).pipe(f(async a=>a)).subscribe(a=>{const t=a.params.barWidth?a.params.barWidth:J({axisWidth:a.axisSize.width,groupAmount:a.computedData[0]?a.computedData[0].length:0,barGroupPadding:a.params.barGroupPadding});e.next(t)})}).pipe(u(s),x()),B=D({gridGraphicTransform:i.gridGraphicTransform$,barWidth:w,params:i.fullParams$}).pipe(u(s),f(async e=>e),d(e=>{const a=e.barWidth/2,t=e.params.barRadius===!0?a:e.params.barRadius===!1?0:typeof e.params.barRadius=="number"?e.params.barRadius:0,r=t==0?0:t/e.gridGraphicTransform.scale[0],m=t==0?0:t/e.gridGraphicTransform.scale[1];return[r,m]})),c=i.visibleComputedData$.pipe(u(s),d(e=>{const a=new Set;return e.forEach(t=>{t.forEach(r=>{a.add(r.groupLabel)})}),Array.from(a)})),y=i.fullChartParams$.pipe(u(s),d(e=>e.transitionDuration),x()),Y=new N(e=>{D({groupLabels:c,transitionDuration:y}).pipe(f(async a=>a)).subscribe(a=>{const t=Q(a.groupLabels.length,a.transitionDuration);e.next(t)})}).pipe(u(s),x()),b=new N(e=>{D({groupLabels:c,transitionDuration:y}).pipe(f(async a=>a)).subscribe(a=>{const t=ee(a.groupLabels.length,a.transitionDuration);e.next(t)})}).pipe(u(s),x()),M=i.visibleComputedData$.pipe(u(s),d(e=>{console.log("visibleComputedData",e);const a=e.length,t=e.reduce((m,h)=>Math.max(m,h.length),0),r=new Array(t).fill(null).map(()=>new Array(a).fill(null));for(let m=0;m<a;m++)for(let h=0;h<t;h++)r[h][m]=e[m][h];return r})),F=D({transposedVisibleData:M,dataFormatter:i.fullDataFormatter$}).pipe(u(s),f(async e=>e),d(e=>{const t=e.transposedVisibleData.length-1,r=e.dataFormatter.groupAxis.scaleDomain[0]==="auto"?0-e.dataFormatter.groupAxis.scalePadding:e.dataFormatter.groupAxis.scaleDomain[0]-e.dataFormatter.groupAxis.scalePadding,m=e.dataFormatter.groupAxis.scaleDomain[1]==="auto"?t+e.dataFormatter.groupAxis.scalePadding:e.dataFormatter.groupAxis.scaleDomain[1]+e.dataFormatter.groupAxis.scalePadding,h=e.transposedVisibleData.map(R=>R.filter((T,z)=>T.groupIndex>=r&&T.groupIndex<=m));if(h.flat().length){const R=h.flat().map(W=>W.axisYFromZero),T=Math.max(...R),z=h.map(W=>W.reduce((U,O)=>U+O.axisYFromZero,0)),E=Math.max(...z);return T/E}else return 1})),p=D({transposedVisibleData:M,yRatio:F,zeroY:I}).pipe(u(s),d(e=>(console.log(e.transposedVisibleData),e.transposedVisibleData.map(a=>{let t=e.zeroY;return a.map(r=>{const m=t,h=r.axisYFromZero*e.yRatio;return t=t+h,{...r,_barStartY:m,_barHeight:h}})}))));i.gridAxesSize$.pipe(u(s)).subscribe(e=>{const a=[{id:l,width:e.width,height:e.height}];ae({defsSelection:S,clipPathData:a})});const G=i.fullChartParams$.pipe(u(s),d(e=>e.highlightTarget),x());D({graphicData:p,zeroY:I,groupLabels:c,params:i.fullParams$,chartParams:i.fullChartParams$,highlightTarget:G,barWidth:w,transformedBarRadius:B,delayGroup:Y,transitionItem:b,SeriesDataMap:i.SeriesDataMap$,GroupDataMap:i.GroupDataMap$}).pipe(u(s),f(async e=>e)).subscribe(e=>{const a=re({selection:P,data:e.graphicData,zeroY:e.zeroY,groupLabels:e.groupLabels,params:e.params,chartParams:e.chartParams,barWidth:e.barWidth,transformedBarRadius:e.transformedBarRadius,delayGroup:e.delayGroup,transitionItem:e.transitionItem});a.on("mouseover",(t,r)=>{t.stopPropagation(),n.event$.next({type:"grid",eventName:"mouseover",pluginName:o,highlightTarget:e.highlightTarget,datum:r,series:e.SeriesDataMap.get(r.seriesLabel),seriesIndex:r.seriesIndex,seriesLabel:r.seriesLabel,groups:e.GroupDataMap.get(r.groupLabel),groupIndex:r.groupIndex,groupLabel:r.groupLabel,event:t,data:e.graphicData})}).on("mousemove",(t,r)=>{t.stopPropagation(),n.event$.next({type:"grid",eventName:"mousemove",pluginName:o,highlightTarget:e.highlightTarget,datum:r,series:e.SeriesDataMap.get(r.seriesLabel),seriesIndex:r.seriesIndex,seriesLabel:r.seriesLabel,groups:e.GroupDataMap.get(r.groupLabel),groupIndex:r.groupIndex,groupLabel:r.groupLabel,event:t,data:e.graphicData})}).on("mouseout",(t,r)=>{t.stopPropagation(),n.event$.next({type:"grid",eventName:"mouseout",pluginName:o,highlightTarget:e.highlightTarget,datum:r,series:e.SeriesDataMap.get(r.seriesLabel),seriesIndex:r.seriesIndex,seriesLabel:r.seriesLabel,groups:e.GroupDataMap.get(r.groupLabel),groupIndex:r.groupIndex,groupLabel:r.groupLabel,event:t,data:e.graphicData})}).on("click",(t,r)=>{t.stopPropagation(),n.event$.next({type:"grid",eventName:"click",pluginName:o,highlightTarget:e.highlightTarget,datum:r,series:e.SeriesDataMap.get(r.seriesLabel),seriesIndex:r.seriesIndex,seriesLabel:r.seriesLabel,groups:e.GroupDataMap.get(r.groupLabel),groupIndex:r.groupIndex,groupLabel:r.groupLabel,event:t,data:e.graphicData})}),A.next(a)});const j=i.gridHighlight$.subscribe();return D({barSelection:A,highlight:i.gridHighlight$,fullChartParams:i.fullChartParams$}).pipe(u(s),f(async e=>e)).subscribe(e=>{te({selection:e.barSelection,ids:e.highlight,fullChartParams:e.fullChartParams})}),()=>{s.next(void 0),j.unsubscribe()}});export{oe as B};

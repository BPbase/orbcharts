import{ap as C,S as M,m as f,d as S,t as y,k as m,l as x,b as T,x as P,L as B,aZ as v,s as d,aV as I,a_ as w,a$ as N,b0 as R,aW as A,b1 as k,b2 as H,r as _,b3 as F,b4 as E}from"./ZOIXw5Nq.js";const O="Bubbles",$=12,U={name:O,defaultParams:P,layerIndex:B,validator:(r,{validateColumns:s})=>{const t=s(r,{force:{toBeTypes:["object"]},bubbleLabel:{toBeTypes:["object"]},arcScaleType:{toBe:'"area" | "radius"',test:n=>n==="area"||n==="radius"}});if(r.force){const n=s(r.force,{velocityDecay:{toBeTypes:["number"]},collisionSpacing:{toBeTypes:["number"]},strength:{toBeTypes:["number"]}});if(n.status==="error")return n}if(r.bubbleLabel){const n=s(r.bubbleLabel,{colorType:{toBeOption:"ColorType"},fillRate:{toBeTypes:["number"]},lineHeight:{toBeTypes:["number"]},maxLineLength:{toBeTypes:["number"]}});if(n.status==="error")return n}return t}};function j(r,s){return w().velocityDecay(s.force.velocityDecay).force("collision",N().radius(t=>t.r+s.force.collisionSpacing)).force("charge",R().strength(t=>-Math.pow(t.r,2)*s.force.strength)).on("tick",()=>{r.attr("transform",t=>`translate(${t.x},${t.y})`)})}function V({visibleComputedSortedData:r,LastBubbleDataMap:s,graphicWidth:t,graphicHeight:n,SeriesContainerPositionMap:c,scaleType:o}){const u=Math.min(t,n)/2,i=r.flat(),b=i.reduce((e,a)=>e+a.value,0),h=A().domain([0,b]).range([0,u]).exponent(o==="area"?.5:1),g=o==="area"?1:(()=>{const e=u*u*Math.PI;return Math.sqrt(e/k(i,a=>Math.PI*Math.pow(h(a.value),2)))})(),p=.9;return i.map(e=>{const a=e,l=s.get(a.id);if(l)a.x=l.x,a.y=l.y;else{const D=c.get(a.seriesLabel);a.x=Math.random()*D.width,a.y=Math.random()*D.height}const L=h(a.value??0)*g*p;return a.r=L,a._originR=L,a})}function W({selection:r,bubblesData:s,fullParams:t,fullChartParams:n,sumSeries:c}){const o=r.selectAll("g").data(s,i=>i.id).join(i=>{const b=i.append("g").attr("cursor","pointer").attr("font-size",$).style("fill","#ffffff").attr("text-anchor","middle");return b.append("circle").attr("class","node").attr("cx",0).attr("cy",0).attr("fill",h=>h.color),b.append("text").style("opacity",.8).attr("pointer-events","none"),b},i=>i,i=>i.remove()).attr("transform",i=>`translate(${i.x},${i.y})`),u=c?"seriesLabel":"label";return o.select("circle").transition().duration(200).attr("r",i=>i.r).attr("fill",i=>i.color),o.each((i,b,h)=>{const g=d(h[b]),p=i[u]??"";g.call(H,{text:p,radius:i.r*t.bubbleLabel.fillRate,lineHeight:$*t.bubbleLabel.lineHeight,isBreakAll:p.length<=t.bubbleLabel.maxLineLength?!1:t.bubbleLabel.wordBreakAll}),g.select("text").attr("fill",e=>_({datum:i,colorType:t.bubbleLabel.colorType,fullChartParams:n}))}),o}function X(r){return v().on("start",(s,t)=>{s.active||r.alpha(1).restart(),t.fx=t.x,t.fy=t.y}).on("drag",(s,t)=>{s.active||r.alphaTarget(0),t.fx=s.x,t.fy=s.y}).on("end",(s,t)=>{t.fx=null,t.fy=null,r.alpha(1).restart()})}function Y({_simulation:r,fullParams:s,SeriesContainerPositionMap:t}){r.force("x",F().strength(s.force.strength).x(n=>t.get(n.seriesLabel).centerX)).force("y",E().strength(s.force.strength).y(n=>t.get(n.seriesLabel).centerY))}function q({bubblesSelection:r,highlightIds:s,fullChartParams:t}){if(r.interrupt("highlight"),!s.length){r.transition("highlight").style("opacity",1);return}r.each((n,c,o)=>{const u=d(o[c]);s.includes(n.id)?u.style("opacity",1).transition("highlight").ease(I).duration(500):u.style("opacity",t.styles.unhighlightedOpacity)})}const G=C(U)(({selection:r,name:s,observer:t,subject:n})=>{const c=new M;let o,u=new Map;const i=t.fullDataFormatter$.pipe(f(e=>e.sumSeries),S()),b=t.fullParams$.pipe(y(c),f(e=>e.arcScaleType),S()),h=m({layout:t.layout$,SeriesContainerPositionMap:t.SeriesContainerPositionMap$,visibleComputedSortedData:t.visibleComputedSortedData$,scaleType:b}).pipe(y(c),x(async e=>e),f(e=>V({visibleComputedSortedData:e.visibleComputedSortedData,LastBubbleDataMap:u,graphicWidth:e.layout.width,graphicHeight:e.layout.height,SeriesContainerPositionMap:e.SeriesContainerPositionMap,scaleType:e.scaleType})),T(1));h.subscribe(e=>{u=new Map(e.map(a=>[a.id,a]))});const g=t.fullChartParams$.pipe(y(c),f(e=>e.highlightTarget),S()),p=m({bubblesData:h,fullParams:t.fullParams$,fullChartParams:t.fullChartParams$,SeriesContainerPositionMap:t.SeriesContainerPositionMap$,sumSeries:i}).pipe(y(c),x(async e=>e),f(e=>{o&&o.stop();const a=W({selection:r,bubblesData:e.bubblesData,fullParams:e.fullParams,fullChartParams:e.fullChartParams,sumSeries:e.sumSeries});return o=j(a,e.fullParams),o.nodes(e.bubblesData),Y({_simulation:o,fullParams:e.fullParams,SeriesContainerPositionMap:e.SeriesContainerPositionMap}),o.alpha(1).restart(),a}),T(1));return m({bubblesSelection:p,computedData:t.computedData$,SeriesDataMap:t.SeriesDataMap$,highlightTarget:g}).pipe(y(c),x(async e=>e)).subscribe(e=>{e.bubblesSelection.on("mouseover",(a,l)=>{n.event$.next({type:"series",eventName:"mouseover",pluginName:s,highlightTarget:e.highlightTarget,datum:l,series:e.SeriesDataMap.get(l.seriesLabel),seriesIndex:l.seriesIndex,seriesLabel:l.seriesLabel,event:a,data:e.computedData})}).on("mousemove",(a,l)=>{n.event$.next({type:"series",eventName:"mousemove",pluginName:s,highlightTarget:e.highlightTarget,datum:l,series:e.SeriesDataMap.get(l.seriesLabel),seriesIndex:l.seriesIndex,seriesLabel:l.seriesLabel,event:a,data:e.computedData})}).on("mouseout",(a,l)=>{n.event$.next({type:"series",eventName:"mouseout",pluginName:s,highlightTarget:e.highlightTarget,datum:l,series:e.SeriesDataMap.get(l.seriesLabel),seriesIndex:l.seriesIndex,seriesLabel:l.seriesLabel,event:a,data:e.computedData})}).on("click",(a,l)=>{n.event$.next({type:"series",eventName:"click",pluginName:s,highlightTarget:e.highlightTarget,datum:l,series:e.SeriesDataMap.get(l.seriesLabel),seriesIndex:l.seriesIndex,seriesLabel:l.seriesLabel,event:a,data:e.computedData})}).call(X(o))}),m({bubblesSelection:p,highlight:t.seriesHighlight$.pipe(f(e=>e.map(a=>a.id))),fullChartParams:t.fullChartParams$}).pipe(y(c),x(async e=>e)).subscribe(e=>{q({bubblesSelection:e.bubblesSelection,highlightIds:e.highlight,fullChartParams:e.fullChartParams})}),()=>{c.next(void 0),o&&(o.stop(),o=void 0)}});export{G as B};

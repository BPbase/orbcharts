import{w as W,S as v,t as S,d as T,e as w,f as L,s as C,L as k,M as z,N as A,g as I,P as E,Q as U,R as O,T as q,O as H,U as _}from"./CKVrw-ui.js";import{c as F}from"./Do0D4Nqc.js";function V(n,{text:s,radius:i,lineHeight:l,isBreakAll:c=!1,limit:h=0}){if(n==null||s==null){console.error("selection or text is not defined");return}i==null&&(i=n.node().getBBox().width/2);function o(a){let e;return c?e=a.split(""):e=a.split(/\s+/g),e[e.length-1]||e.pop(),e[0]||e.shift(),e}function g(a,e){return a&&e&&a.length>e&&(a=a.substring(0,e)+"..."),a}function f(a){var r;const e=document.createElement("canvas").getContext("2d");return((r=e==null?void 0:e.measureText(a))==null?void 0:r.width)??0}function m(a){const e=f(a.trim());return Math.sqrt(e*l)}function M(a,e){let r={width:0,text:""},p=1/0;const b=[];let y=" ";c&&(y="");for(let x=0,d=a.length;x<d;++x){const $=(r.text?r.text+y:"")+a[x],P=f($);(p+P)/2<e?(r.width=p=P,r.text=$):(p=f(a[x]),r={width:p,text:a[x]},b.push(r))}return b}function t(a){let e=0;for(let r=0,p=a.length;r<p;++r){const b=(Math.abs(r-p/2+.5)+.5)*l,y=a[r].width/2;e=Math.max(e,Math.sqrt(y**2+b**2))}return e}function u(a,e){h>0&&(e=g(e,h));const r=o(e),p=m(e),b=M(r,p),y=t(b);let x=a.select("text");x.size()||(x=a.append("text")),x.attr("transform",`translate(0,0) scale(${i/y})`);const d=x.selectAll("tspan").data(b),$=d.enter().append("tspan").attr("x",0).merge(d).attr("y",(P,N)=>(N-b.length/2+.8)*l).text(P=>P.text);return d.exit().remove(),d.merge($)}return u(n,s)}let D;function G(n,s){return k().velocityDecay(s.force.velocityDecay).force("collision",z().radius(i=>i.r+s.force.collisionSpacing)).force("charge",A().strength(i=>-Math.pow(i.r,2)*s.force.strength)).on("tick",()=>{n.attr("transform",i=>`translate(${i.x},${i.y})`)})}function Q({data:n,bubbleGroupR:s,maxValue:i,avgValue:l}){const c=s/Math.sqrt(n.length),o=c*c*Math.PI/l,g=i*o;return Math.pow(g/Math.PI,.5)*.75}function X({data:n,LastBubbleDataMap:s,graphicWidth:i,graphicHeight:l,SeriesContainerPositionMap:c,scaleType:h}){const o=Math.min(i,l)/2,g=n.flat().filter(e=>e.value!=null&&e.visible!=!1),f=Math.max(...g.map(e=>e.value)),m=g.reduce((e,r)=>e+(r.value??0),0)/g.length,M=Q({data:g,bubbleGroupR:o,maxValue:f,avgValue:m}),t=h==="area"?.5:1,u=_().domain([0,f]).range([0,M]).exponent(t);return g.map(e=>{const r=e,p=s.get(e.id);if(p)r.x=p.x,r.y=p.y;else{const y=c.get(r.seriesLabel);r.x=Math.random()*y.width,r.y=Math.random()*y.height}const b=u(r.value??0);return r.r=b,r._originR=b,r})}function R({graphicSelection:n,bubblesData:s,fullParams:i}){let l=n.selectAll("g").data(s,o=>o.id),c=l.enter().append("g").attr("cursor","pointer");c.attr("font-size",12).style("fill","#ffffff").attr("text-anchor","middle").attr("transform",o=>`translate(${o.x},${o.y})`),c.append("circle").attr("class","node").attr("cx",0).attr("cy",0).attr("fill",o=>o.color),c.append("text").style("opacity",.8).attr("pointer-events","none"),l.exit().remove();const h=l.merge(c);return h.select("circle").transition().duration(200).attr("r",o=>o.r).attr("fill",o=>o.color),h.each((o,g,f)=>{const m=I(f[g]);let M=!0;o.label.length<=i.bubbleText.lineLengthMin&&(M=!1),m.call(V,{text:o.label,radius:o.r*i.bubbleText.fillRate,lineHeight:i.bubbleText.lineHeight,isBreakAll:M})}),h}function Y({data:n,highlightRIncrease:s,highlightIds:i}){if(s!=0){if(!i.length){n.forEach(l=>l.r=l._originR);return}n.forEach(l=>{i.includes(l.id)?l.r=l._originR+s:l.r=l._originR})}}function J(){return E().on("start",(n,s)=>{n.active||D.alpha(1).restart(),s.fx=s.x,s.fy=s.y}).on("drag",(n,s)=>{n.active||D.alphaTarget(0),s.fx=n.x,s.fy=n.y}).on("end",(n,s)=>{s.fx=null,s.fy=null})}function B({fullParams:n,SeriesContainerPositionMap:s}){D.force("x",U().strength(n.force.strength).x(i=>s.get(i.seriesLabel).centerX)).force("y",O().strength(n.force.strength).y(i=>s.get(i.seriesLabel).centerY)),D.alpha(1).restart()}function K({bubblesSelection:n,highlightIds:s,fullChartParams:i}){if(n.interrupt("highlight"),!s.length){n.transition("highlight").style("opacity",1);return}n.each((l,c,h)=>{const o=I(h[c]);s.includes(l.id)?o.style("opacity",1).transition("highlight").ease(q).duration(500):o.style("opacity",i.styles.unhighlightedOpacity)})}const ee=W("Bubbles",F)(({selection:n,name:s,observer:i,subject:l})=>{const c=new v,h=n.append("g"),o=new v;let g=new Map;const f=i.fullParams$.pipe(S(c),T(t=>t.bubbleScaleType),w()),m=new H(t=>{L({layout:i.layout$,SeriesContainerPositionMap:i.SeriesContainerPositionMap$,visibleComputedLayoutData:i.visibleComputedLayoutData$,scaleType:f}).pipe(S(c),C(async u=>u)).subscribe(u=>{const a=X({data:u.visibleComputedLayoutData,LastBubbleDataMap:g,graphicWidth:u.layout.width,graphicHeight:u.layout.height,SeriesContainerPositionMap:u.SeriesContainerPositionMap,scaleType:u.scaleType});t.next(a)})});m.subscribe(t=>{g=new Map(t.map(u=>[u.id,u]))});const M=i.fullChartParams$.pipe(S(c),T(t=>t.highlightTarget),w());return L({layout:i.layout$,computedData:i.computedData$,bubblesData:m,SeriesDataMap:i.SeriesDataMap$,fullParams:i.fullParams$,highlightTarget:M,SeriesContainerPositionMap:i.SeriesContainerPositionMap$}).pipe(S(c),C(async t=>t)).subscribe(t=>{const u=R({graphicSelection:h,bubblesData:t.bubblesData,fullParams:t.fullParams});D=G(u,t.fullParams),u.on("mouseover",(a,e)=>{l.event$.next({type:"series",eventName:"mouseover",pluginName:s,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:a,data:t.computedData})}).on("mousemove",(a,e)=>{l.event$.next({type:"series",eventName:"mousemove",pluginName:s,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:a,data:t.computedData})}).on("mouseout",(a,e)=>{l.event$.next({type:"series",eventName:"mouseout",pluginName:s,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:a,data:t.computedData})}).on("click",(a,e)=>{l.event$.next({type:"series",eventName:"click",pluginName:s,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:a,data:t.computedData})}).call(J()),D.nodes(t.bubblesData),B({fullParams:t.fullParams,SeriesContainerPositionMap:t.SeriesContainerPositionMap}),o.next(u)}),L({bubblesSelection:o,bubblesData:m,highlight:i.seriesHighlight$.pipe(T(t=>t.map(u=>u.id))),fullChartParams:i.fullChartParams$,fullParams:i.fullParams$,SeriesContainerPositionMap:i.SeriesContainerPositionMap$}).pipe(S(c),C(async t=>t)).subscribe(t=>{K({bubblesSelection:t.bubblesSelection,highlightIds:t.highlight,fullChartParams:t.fullChartParams}),t.fullParams.highlightRIncrease&&(Y({data:t.bubblesData,highlightRIncrease:t.fullParams.highlightRIncrease,highlightIds:t.highlight}),R({graphicSelection:h,bubblesData:t.bubblesData,fullParams:t.fullParams})),B({fullParams:t.fullParams,SeriesContainerPositionMap:t.SeriesContainerPositionMap}),D.nodes(t.bubblesData)}),()=>{c.next(void 0)}});export{ee as B};

import{ai as R,ap as U,at as z,b2 as w,aw as q,b3 as J,az as V,aj as b,ah as W,b4 as X,A as Y,b5 as G,b6 as E,S as I,t as x,m as C,a4 as K,aB as Q,k as L,l as O,b as Z,a5 as tt,L as et,s as P,a6 as at,af as rt}from"./CJz0rwbW.js";import{c as lt}from"./2ZDPLa8x.js";import{q as ot,s as nt,r as it,j as _,g as k}from"./D7qTWgnP.js";import{o as st}from"./8yQJIOUQ.js";import{c as ct}from"./B0XiZ-1Y.js";const ut=({computedData$:o})=>o.pipe(R(a=>{function r(e,n){return e.push(n),n.children&&n.children.forEach(s=>{e=r(e,s)}),e}return r([],a)})),pt=o=>o.pipe(R(a=>Array.from(a.keys())),U((a,r)=>JSON.stringify(a).length===JSON.stringify(r).length)),gt=({computedData$:o})=>o.pipe(R(a=>{function r(e){return e.children&&(e.children=e.children.filter(n=>n.visible).map(n=>r(n))),e}return r(a)})),dt=o=>z(o,{visibleFilter:{toBeTypes:["Function"]},categoryLabels:{toBeTypes:["string[]"]}}),yt=o=>{const{data:a=[],dataFormatter:r,chartParams:e}=o,n=J(),s=new Map(r.categoryLabels.map((u,t)=>[u,t]));let g={id:"",index:0,label:"",description:"",categoryIndex:-1,categoryLabel:"",color:"",visible:!0,data:{},value:0,level:0,seq:0,children:[]};try{const u=function(){if(w(a)===!0)return JSON.parse(JSON.stringify(a));if(Array.isArray(a)===!1)return{id:""};let l;const y=new Map;a.forEach(p=>{if(!p.parent)l=p;else{const d=y.get(p.parent)??[];d.push(p),y.set(p.parent,d)}});const i=p=>({id:p.id,label:p.label,data:p.data,value:p.value,categoryLabel:p.categoryLabel??n,children:(y.get(p.id)??[]).map(d=>i(d))});return l?i(l):{id:""}}();let t=0;const c=(l,y,i)=>{const p=y+1,d=l.categoryLabel??n;s.has(d)||s.set(d,s.size);const B=s.get(d)??0,h=t;t++;const m={id:l.id,index:h,level:y,seq:i,label:l.label??"",description:l.description??"",categoryIndex:B,categoryLabel:d,color:q(B,e),data:l.data??{},value:l.value,visible:!0,children:(l.children??[]).map((A,$)=>c(A,p,$))};return m.visible=r.visibleFilter(m,o),m};g=c(u,0,0)}catch(u){throw Error(u)}return g},mt=o=>z({data:o},{data:{toBe:"DataTreeObj | DataTreeDatum[]",test:r=>w(r)&&r.id!==void 0}}),ht=({subject:o,observer:a})=>{const r=V(a.fullChartParams$).pipe(b(1)),e=ut({computedData$:a.computedData$}).pipe(b(1)),n=W({datumList$:e,fullChartParams$:a.fullChartParams$,event$:o.event$}).pipe(b(1)),s=X({datumList$:e}).pipe(b(1)),g=pt(s).pipe(b(1)),u=gt({computedData$:a.computedData$}).pipe(b(1));return{fullParams$:a.fullParams$,fullChartParams$:a.fullChartParams$,fullDataFormatter$:a.fullDataFormatter$,computedData$:a.computedData$,layout$:a.layout$,textSizePx$:r,treeHighlight$:n,categoryLabels$:g,CategoryDataMap$:s,visibleComputedData$:u}};class Bt extends Y{constructor(a,r){super({defaultDataFormatter:G,dataFormatterValidator:dt,computedDataFn:yt,dataValidator:mt,contextObserverCallback:ht},a,r)}}const j="TreeLegend",ft={name:j,defaultParams:K,layerIndex:Q,validator:(o,{validateColumns:a})=>a(o,{placement:{toBe:'"top" | "top-start" | "top-end" | "bottom" | "bottom-start" | "bottom-end" | "left" | "left-start" | "left-end" | "right" | "right-start" | "right-end"',test:e=>["top","top-start","top-end","bottom","bottom-start","bottom-end","left","left-start","left-end","right","right-start","right-end"].includes(e)},padding:{toBeTypes:["number"]},backgroundFill:{toBeOption:"ColorType"},backgroundStroke:{toBeOption:"ColorType"},gap:{toBeTypes:["number"]},listRectWidth:{toBeTypes:["number"]},listRectHeight:{toBeTypes:["number"]},listRectRadius:{toBeTypes:["number"]},textColorType:{toBeOption:"ColorType"}})},At=E(ft)(({selection:o,rootSelection:a,observer:r,subject:e})=>{const n=new I,s=r.fullParams$.pipe(x(n),C(u=>{const t=[{listRectWidth:u.listRectWidth,listRectHeight:u.listRectHeight,listRectRadius:u.listRectRadius}];return{...u,labelList:t}})),g=lt(j,{rootSelection:a,legendLabels$:r.categoryLabels$,fullParams$:s,layout$:r.layout$,fullChartParams$:r.fullChartParams$,textSizePx$:r.textSizePx$});return()=>{n.next(void 0),g()}}),f="TreeMap",M=k(f,"tree"),v=k(f,"tile"),$t={name:f,defaultParams:tt,layerIndex:et,validator:(o,{validateColumns:a})=>a(o,{paddingInner:{toBeTypes:["number"]},paddingOuter:{toBeTypes:["number"]},labelColorType:{toBeOption:"ColorType"},squarifyRatio:{toBeTypes:["number"]},sort:{toBeTypes:["Function"]}})};function bt({selection:o,treeData:a,fullParams:r,fullChartParams:e,textSizePx:n}){const s=n/2,g=n,u=o.selectAll(`g.${M}`).data(a,t=>t.data.id).join("g").attr("class",M);return u.attr("transform",t=>!t.x0||!t.y0?null:`translate(${t.x0},${t.y0})`).each((t,c,l)=>{const y=P(l[c]);y.selectAll(`rect.${v}`).data([t],i=>i.data.id).join("rect").attr("id",i=>i.data.id).attr("class",v).attr("cursor","pointer").attr("width",i=>i.x1-i.x0).attr("height",i=>i.y1-i.y0).attr("fill",i=>i.data.color).attr("data-name",i=>i.data.label).attr("data-category",i=>i.data.categoryLabel).attr("data-value",i=>i.data.value),y.selectAll("g").data([t]).join("g").each((i,p,d)=>{P(d[p]).selectAll("text").data([i]).join("text").text(h=>h.data.label).attr("dominant-baseline","hanging").attr("x",s).attr("y",s).attr("font-size",e.styles.textSize).each(function(h){const m=P(this),A=h.data.label.split(/\s+/).reverse();let $,T=[];const S=m.attr("x");let F=m.attr("y"),N=0,D=m.text(null).append("tspan").attr("cursor","pointer").attr("fill",_(r.labelColorType,e)).attr("font-size",e.styles.textSize).attr("x",S).attr("y",F);for(;$=A.pop();)T.push($),D.text(T.join(" ")),D.node().getComputedTextLength()>h.x1-h.x0-s&&(T.pop(),D.text(T.join(" ")),T=[$],N+=g,D=m.append("tspan").attr("cursor","pointer").attr("fill",_(r.labelColorType,e)).attr("font-size",e.styles.textSize).attr("x",S).attr("y",F).attr("dy",N+"px").text($))})})}),u}function xt({selection:o,ids:a,fullChartParams:r}){if(o.interrupt("highlight"),!a.length){o.transition("highlight").duration(200).style("opacity",1);return}o.each((e,n,s)=>{a.includes(e.data.id)?P(s[n]).style("opacity",1):P(s[n]).style("opacity",r.styles.unhighlightedOpacity)})}const Rt=E($t)(({selection:o,name:a,subject:r,observer:e})=>{const n=new I,s=L({layout:e.layout$,visibleComputedData:e.visibleComputedData$,fullParams:e.fullParams$,fullDataFormatter:e.fullDataFormatter$,fullChartParams:e.fullChartParams$}).pipe(x(n),O(async t=>t),C(t=>{const c=ot().size([t.layout.width,t.layout.height]).paddingInner(t.fullParams.paddingInner).paddingOuter(t.fullParams.paddingOuter).round(!0).tile(nt.ratio(t.fullParams.squarifyRatio)),l=it(t.visibleComputedData).sum(i=>i.value).sort(t.fullParams.sort);return c(l),l.leaves()})),g=L({selection:st(o),treeData:s,fullParams:e.fullParams$,fullChartParams:e.fullChartParams$,textSizePx:e.textSizePx$}).pipe(x(n),O(async t=>t),C(t=>bt({selection:o,treeData:t.treeData,fullParams:t.fullParams,fullChartParams:t.fullChartParams,textSizePx:t.textSizePx}))),u=e.fullChartParams$.pipe(x(n),C(t=>t.highlightTarget),Z());return L({cellSelection:g,computedData:e.computedData$,treeData:s,fullParams:e.fullParams$,fullChartParams:e.fullChartParams$,highlightTarget:u,CategoryDataMap:e.CategoryDataMap$}).pipe(x(n),O(async t=>t)).subscribe(t=>{t.cellSelection.on("mouseover",(c,l)=>{c.stopPropagation(),r.event$.next({type:"tree",eventName:"mouseover",pluginName:f,highlightTarget:t.highlightTarget,datum:l.data,category:t.CategoryDataMap.get(l.data.categoryLabel),categoryIndex:l.data.categoryIndex,categoryLabel:l.data.categoryLabel,event:c,data:t.computedData})}).on("mousemove",(c,l)=>{c.stopPropagation(),r.event$.next({type:"tree",eventName:"mousemove",pluginName:f,highlightTarget:t.highlightTarget,datum:l.data,category:t.CategoryDataMap.get(l.data.categoryLabel),categoryIndex:l.data.categoryIndex,categoryLabel:l.data.categoryLabel,event:c,data:t.computedData})}).on("mouseout",(c,l)=>{c.stopPropagation(),r.event$.next({type:"tree",eventName:"mouseout",pluginName:f,highlightTarget:t.highlightTarget,datum:l.data,category:t.CategoryDataMap.get(l.data.categoryLabel),categoryIndex:l.data.categoryIndex,categoryLabel:l.data.categoryLabel,event:c,data:t.computedData})}).on("click",(c,l)=>{c.stopPropagation(),r.event$.next({type:"tree",eventName:"click",pluginName:f,highlightTarget:t.highlightTarget,datum:l.data,category:t.CategoryDataMap.get(l.data.categoryLabel),categoryIndex:l.data.categoryIndex,categoryLabel:l.data.categoryLabel,event:c,data:t.computedData})})}),L({cellSelection:g,highlight:e.treeHighlight$.pipe(C(t=>t.map(c=>c.id))),fullChartParams:e.fullChartParams$}).pipe(x(n),O(async t=>t)).subscribe(t=>{xt({selection:t.cellSelection,ids:t.highlight,fullChartParams:t.fullChartParams})}),()=>{n.next(void 0)}}),H="TreeTooltip",Tt={name:H,defaultParams:at,layerIndex:rt,validator:(o,{validateColumns:a})=>a(o,{backgroundColorType:{toBeOption:"ColorType"},backgroundOpacity:{toBeTypes:["number"]},strokeColorType:{toBeOption:"ColorType"},offset:{toBe:"[number, number]",test:e=>Array.isArray(e)&&e.length===2&&typeof e[0]=="number"&&typeof e[1]=="number"},padding:{toBeTypes:["number"]},textColorType:{toBeOption:"ColorType"},renderFn:{toBeTypes:["Function"]}})},Et=E(Tt)(({selection:o,rootSelection:a,name:r,subject:e,observer:n})=>{const s=new I,g=ct(H,{rootSelection:a,fullParams$:n.fullParams$,fullChartParams$:n.fullChartParams$,layout$:n.layout$,event$:e.event$});return()=>{s.next(void 0),g()}});export{At as T,Rt as a,Et as b,Bt as c};

import{a7 as O,ae as I,a9 as J,aa as U,ai as _,b5 as z,al as q,an as V,a8 as $,a6 as W,b6 as G,A as X,b7 as Y,b8 as w,S as j,t as y,m as x,_ as K,ap as Q,n as T,o as S,d as Z,$ as tt,L as et,s as D}from"./D0O9ZvbE.js";import{c as at}from"./2MvoWBLz.js";import{r as rt,s as lt,t as it,j as M,g as k}from"./CLAZhRXT.js";import{o as st}from"./DM6OFWi-.js";const nt=({computedData$:o})=>o.pipe(O(r=>{function i(e,a){return e.push(a),a.children&&a.children.forEach(u=>{e=i(e,u)}),e}return i([],r)})),ot=({nodeList$:o,fullDataFormatter$:r})=>{const i=r.pipe(O(e=>e.categoryLabels),I((e,a)=>JSON.stringify(e).length===JSON.stringify(a).length));return J({nodeList:o,categoryLabels:i}).pipe(U(async e=>e),O(e=>{const a=new Set(e.categoryLabels),u=new Set(e.nodeList.filter(c=>c.visible).map(c=>c.categoryLabel));return Array.from(u).forEach(c=>{a.has(c)||a.add(c)}),Array.from(a).forEach(c=>{u.has(c)||u.delete(c)}),Array.from(a)}),I((e,a)=>JSON.stringify(e).length===JSON.stringify(a).length))},ct=({computedData$:o})=>o.pipe(O(r=>{function i(e){return e.children&&(e.children=e.children.filter(a=>a.visible).map(a=>i(a))),e}return i(r)})),ut=o=>_(o,{visibleFilter:{toBeTypes:["Function"]},categoryLabels:{toBeTypes:["string[]"]}}),pt=o=>{const{data:r=[],dataFormatter:i,chartParams:e}=o,a=new Map(i.categoryLabels.map((c,p)=>[c,p]));let u={id:"",index:0,label:"",description:"",categoryIndex:0,categoryLabel:"",color:"",visible:!0,data:{},value:0,level:0,seq:0,children:[]};try{const c=function(){if(z(r)===!0)return JSON.parse(JSON.stringify(r));if(Array.isArray(r)===!1)return{id:""};let s;const n=new Map;r.forEach(l=>{if(!l.parent)s=l;else{const g=n.get(l.parent)??[];g.push(l),n.set(l.parent,g)}});const h=l=>({id:l.id,label:l.label,data:l.data,value:l.value,categoryLabel:l.categoryLabel,children:(n.get(l.id)??[]).map(g=>h(g))});return s?h(s):{id:""}}();let p=0;const t=(s,n,h)=>{const l=n+1,g=s.categoryLabel??null;let b=0;g!=null&&(a.has(g)||a.set(g,a.size),b=a.get(g)??0);const R=p;p++;const d={id:s.id,index:R,level:n,seq:h,label:s.label??"",description:s.description??"",categoryIndex:b,categoryLabel:g,color:q(b,e),data:s.data??{},value:s.value,visible:!0,children:(s.children??[]).map((f,A)=>t(f,l,A))};return d.visible=i.visibleFilter(d,o),d};u=t(c,0,0)}catch(c){throw Error(c)}return u},gt=o=>_({data:o},{data:{toBe:"DataTreeObj | DataTreeDatum[]",test:i=>z(i)&&i.id!==void 0}}),dt=({subject:o,observer:r})=>{const i=V(r.fullChartParams$).pipe($(1)),e=nt({computedData$:r.computedData$}).pipe($(1)),a=W({datumList$:e,fullChartParams$:r.fullChartParams$,event$:o.event$}).pipe($(1)),u=ot({nodeList$:e,fullDataFormatter$:r.fullDataFormatter$}).pipe($(1)),c=G({datumList$:e}).pipe($(1)),p=ct({computedData$:r.computedData$}).pipe($(1));return{fullParams$:r.fullParams$,fullChartParams$:r.fullChartParams$,fullDataFormatter$:r.fullDataFormatter$,computedData$:r.computedData$,layout$:r.layout$,textSizePx$:i,treeHighlight$:a,existCategoryLabels$:u,CategoryDataMap$:c,visibleComputedData$:p}};class Dt extends X{constructor(r,i){super({defaultDataFormatter:Y,dataFormatterValidator:ut,computedDataFn:pt,dataValidator:gt,contextObserverCallback:dt},r,i)}}const H="TreeLegend",ht={name:H,defaultParams:K,layerIndex:Q,validator:(o,{validateColumns:r})=>r(o,{padding:{toBeTypes:["number"]},backgroundFill:{toBeOption:"ColorType"},backgroundStroke:{toBeOption:"ColorType"},gap:{toBeTypes:["number"]},listRectWidth:{toBeTypes:["number"]},listRectHeight:{toBeTypes:["number"]},listRectRadius:{toBeTypes:["number"]},textColorType:{toBeOption:"ColorType"}})},Lt=w(ht)(({selection:o,rootSelection:r,observer:i,subject:e})=>{const a=new j,u=i.CategoryDataMap$.pipe(y(a),x(t=>Array.from(t.keys()))),c=i.fullParams$.pipe(y(a),x(t=>{const s=[{listRectWidth:t.listRectWidth,listRectHeight:t.listRectHeight,listRectRadius:t.listRectRadius}];return{...t,seriesList:s}})),p=at(H,{rootSelection:r,seriesLabels$:u,fullParams$:c,layout$:i.layout$,fullChartParams$:i.fullChartParams$,textSizePx$:i.textSizePx$});return()=>{a.next(void 0),p()}}),m="TreeMap",v=k(m,"tree"),N=k(m,"tile"),yt={name:m,defaultParams:tt,layerIndex:et,validator:(o,{validateColumns:r})=>r(o,{paddingInner:{toBeTypes:["number"]},paddingOuter:{toBeTypes:["number"]},labelColorType:{toBeOption:"ColorType"},squarifyRatio:{toBeTypes:["number"]},sort:{toBeTypes:["Function"]}})};function mt({selection:o,treeData:r,fullParams:i,fullChartParams:e,textSizePx:a}){const u=a/2,c=a,p=o.selectAll(`g.${v}`).data(r,t=>t.data.id).join("g").attr("class",v);return p.attr("transform",t=>!t.x0||!t.y0?null:`translate(${t.x0},${t.y0})`).each((t,s,n)=>{const h=D(n[s]);h.selectAll(`rect.${N}`).data([t],l=>l.data.id).join("rect").attr("id",l=>l.data.id).attr("class",N).attr("cursor","pointer").attr("width",l=>l.x1-l.x0).attr("height",l=>l.y1-l.y0).attr("fill",l=>l.data.color).attr("data-name",l=>l.data.label).attr("data-category",l=>l.data.categoryLabel).attr("data-value",l=>l.data.value),h.selectAll("g").data([t]).join("g").each((l,g,b)=>{D(b[g]).selectAll("text").data([l]).join("text").text(d=>d.data.label).attr("dominant-baseline","hanging").attr("x",u).attr("y",u).attr("font-size",e.styles.textSize).each(function(d){const f=D(this),A=d.data.label.split(/\s+/).reverse();let L,C=[];const E=f.attr("x");let B=f.attr("y"),F=0,P=f.text(null).append("tspan").attr("cursor","pointer").attr("fill",M(i.labelColorType,e)).attr("font-size",e.styles.textSize).attr("x",E).attr("y",B);for(;L=A.pop();)C.push(L),P.text(C.join(" ")),P.node().getComputedTextLength()>d.x1-d.x0-u&&(C.pop(),P.text(C.join(" ")),C=[L],F+=c,P=f.append("tspan").attr("cursor","pointer").attr("fill",M(i.labelColorType,e)).attr("font-size",e.styles.textSize).attr("x",E).attr("y",B).attr("dy",F+"px").text(L))})})}),p}function ft({selection:o,ids:r,fullChartParams:i}){if(o.interrupt("highlight"),!r.length){o.transition("highlight").duration(200).style("opacity",1);return}o.each((e,a,u)=>{r.includes(e.data.id)?D(u[a]).style("opacity",1):D(u[a]).style("opacity",i.styles.unhighlightedOpacity)})}const Pt=w(yt)(({selection:o,name:r,subject:i,observer:e})=>{const a=new j,u=T({layout:e.layout$,visibleComputedData:e.visibleComputedData$,fullParams:e.fullParams$,fullDataFormatter:e.fullDataFormatter$,fullChartParams:e.fullChartParams$}).pipe(y(a),S(async t=>t),x(t=>{const s=rt().size([t.layout.width,t.layout.height]).paddingInner(t.fullParams.paddingInner).paddingOuter(t.fullParams.paddingOuter).round(!0).tile(lt.ratio(t.fullParams.squarifyRatio)),n=it(t.visibleComputedData).sum(l=>l.value).sort(t.fullParams.sort);return s(n),n.leaves()})),c=T({selection:st(o),treeData:u,fullParams:e.fullParams$,fullChartParams:e.fullChartParams$,textSizePx:e.textSizePx$}).pipe(y(a),S(async t=>t),x(t=>mt({selection:o,treeData:t.treeData,fullParams:t.fullParams,fullChartParams:t.fullChartParams,textSizePx:t.textSizePx}))),p=e.fullChartParams$.pipe(y(a),x(t=>t.highlightTarget),Z());return T({cellSelection:c,computedData:e.computedData$,treeData:u,fullParams:e.fullParams$,fullChartParams:e.fullChartParams$,highlightTarget:p,CategoryDataMap:e.CategoryDataMap$}).pipe(y(a),S(async t=>t)).subscribe(t=>{t.cellSelection.on("mouseover",(s,n)=>{s.stopPropagation(),i.event$.next({type:"tree",eventName:"mouseover",pluginName:m,highlightTarget:t.highlightTarget,datum:n.data,category:t.CategoryDataMap.get(n.data.categoryLabel),categoryIndex:n.data.categoryIndex,categoryLabel:n.data.categoryLabel,event:s,data:t.computedData})}).on("mousemove",(s,n)=>{s.stopPropagation(),i.event$.next({type:"tree",eventName:"mousemove",pluginName:m,highlightTarget:t.highlightTarget,datum:n.data,category:t.CategoryDataMap.get(n.data.categoryLabel),categoryIndex:n.data.categoryIndex,categoryLabel:n.data.categoryLabel,event:s,data:t.computedData})}).on("mouseout",(s,n)=>{s.stopPropagation(),i.event$.next({type:"tree",eventName:"mouseout",pluginName:m,highlightTarget:t.highlightTarget,datum:n.data,category:t.CategoryDataMap.get(n.data.categoryLabel),categoryIndex:n.data.categoryIndex,categoryLabel:n.data.categoryLabel,event:s,data:t.computedData})}).on("click",(s,n)=>{s.stopPropagation(),i.event$.next({type:"tree",eventName:"click",pluginName:m,highlightTarget:t.highlightTarget,datum:n.data,category:t.CategoryDataMap.get(n.data.categoryLabel),categoryIndex:n.data.categoryIndex,categoryLabel:n.data.categoryLabel,event:s,data:t.computedData})})}),T({cellSelection:c,highlight:e.treeHighlight$.pipe(x(t=>t.map(s=>s.id))),fullChartParams:e.fullChartParams$}).pipe(y(a),S(async t=>t)).subscribe(t=>{ft({selection:t.cellSelection,ids:t.highlight,fullChartParams:t.fullChartParams})}),()=>{a.next(void 0)}});export{Lt as T,Pt as a,Dt as b};

import{S as le,n as a,t as c,o as h,m as f,d as D,e as z,s as k}from"./CllDRATP.js";import{g as Y,i as re,j as T}from"./CWRPK8C-.js";const oe={listRectWidth:14,listRectHeight:14,listRectRadius:0};function K(y,g){const b=y<g.colors[g.colorScheme].series.length?y:y%g.colors[g.colorScheme].series.length;return g.colors[g.colorScheme].series[b]}const me=(y,{rootSelection:g,seriesLabels$:b,fullParams$:p,layout$:E,fullChartParams$:C,textSizePx$:H})=>{const M=Y(y,"root-position"),O=Y(y,"legend-card"),Q=Y(y,"legend-list"),N=Y(y,"legend-item"),o=new le,V=a({seriesLabels:b,fullChartParams:C}).pipe(c(o),h(async e=>e),f(e=>{const t=new Map;let i=0;return e.seriesLabels.forEach((s,n)=>{if(!t.has(s)){const u=K(i,e.fullChartParams);t.set(s,u),i++}}),t})),Z=b.pipe(c(o),f(e=>{const t=new Set;let i=[];return e.forEach(s=>{t.has(s)?i.push(!1):i.push(!0),t.add(s)}),i})),X=p.pipe(c(o),f(e=>e.placement==="top"||e.placement==="top-start"||e.placement==="top-end"?"top":e.placement==="bottom"||e.placement==="bottom-start"||e.placement==="bottom-end"?"bottom":e.placement==="left"||e.placement==="left-start"||e.placement==="left-end"?"left":"right"),D((e,t)=>e===t),z(1)),U=p.pipe(c(o),f(e=>e.placement==="top-start"||e.placement==="bottom-start"||e.placement==="left-start"||e.placement==="right-start"?"start":e.placement==="top-end"||e.placement==="bottom-end"||e.placement==="left-end"||e.placement==="right-end"?"end":(e.placement==="top"||e.placement==="bottom"||e.placement==="left"||e.placement==="right","center")),D((e,t)=>e===t),z(1)),B=X.pipe(c(o),f(e=>e==="bottom"||e==="top"?"row":"column"),D((e,t)=>e===t),z(1)),v=a({fullParams:p,position:X,layout:E}).pipe(c(o),h(async e=>e),f(e=>{const t=e.fullParams.padding*2+e.fullParams.gap*2;return e.position==="bottom"||e.position==="top"?e.layout.rootWidth-t:e.layout.rootHeight-t})),_=a({layout:E,position:X,justify:U}).pipe(c(o),h(async e=>e),f(e=>{let t=0,i=0;return e.position==="bottom"?(i=e.layout.rootHeight,e.justify==="start"?t=0:e.justify==="center"?t=e.layout.rootWidth/2:e.justify==="end"&&(t=e.layout.rootWidth)):e.position==="right"?(t=e.layout.rootWidth,e.justify==="start"?i=0:e.justify==="center"?i=e.layout.rootHeight/2:e.justify==="end"&&(i=e.layout.rootHeight)):e.position==="top"?(i=0,e.justify==="start"?t=0:e.justify==="center"?t=e.layout.rootWidth/2:e.justify==="end"&&(t=e.layout.rootWidth)):e.position==="left"&&(t=0,e.justify==="start"?i=0:e.justify==="center"?i=e.layout.rootHeight/2:e.justify==="end"&&(i=e.layout.rootHeight)),{x:t,y:i}})).pipe(c(o),f(e=>g.selectAll(`g.${M}`).data([e]).join(t=>t.append("g").classed(M,!0).attr("transform",i=>`translate(${i.x}, ${i.y})`),t=>t.transition().attr("transform",i=>`translate(${i.x}, ${i.y})`),t=>t.remove()))),ee=p.pipe(c(o),f(e=>e.seriesList[0]?e.seriesList[0]:oe)),F=a({visibleList:Z,fullParams:p,fullChartParams:C,seriesLabels:b,lineDirection:B,lineMaxSize:v,defaultListStyle:ee,SeriesLabelColorMap:V,textSizePx:H}).pipe(c(o),h(async e=>e),f(e=>e.seriesLabels.reduce((t,i,s)=>{if(!e.visibleList[s])return t;const n=re(i,e.textSizePx),u=e.textSizePx*1.5+n,x=e.SeriesLabelColorMap.get(i),P=t[0]&&t[0][0]?t[t.length-1][t[t.length-1].length-1]:null,{translateX:l,translateY:A,lineIndex:S,itemIndex:j}=((m,q,r)=>{let W=0,w=0,d=0,R=0;if(m.lineDirection==="column"){let $=r?r.translateY+m.textSizePx+m.fullParams.gap:0;if($+m.textSizePx>m.lineMaxSize){d=r.lineIndex+1,R=0,w=0;const ne=q[q.length-1].reduce((G,J)=>J.itemWidth>G?J.itemWidth:G,0);W=r.translateX+ne+m.fullParams.gap}else d=r?r.lineIndex:0,R=r?r.itemIndex+1:0,w=$,W=r?r.translateX:0}else{let $=r?r.translateX+r.itemWidth+m.fullParams.gap:0;$+u>m.lineMaxSize?(d=r.lineIndex+1,R=0,W=0):(d=r?r.lineIndex:0,R=r?r.itemIndex+1:0,W=$),w=(m.textSizePx+m.fullParams.gap)*d}return{translateX:W,translateY:w,lineIndex:d,itemIndex:R}})(e,t,P);t[S]||(t[S]=[]);const L=e.fullParams.seriesList[j]?e.fullParams.seriesList[j]:e.defaultListStyle;return t[S].push({id:i,seriesLabel:i,seriesIndex:s,lineIndex:S,itemIndex:j,text:i,itemWidth:u,translateX:l,translateY:A,color:x,listRectWidth:L.listRectWidth,listRectHeight:L.listRectHeight,listRectRadius:L.listRectRadius}),t},[])),z(1)),I=a({fullParams:p,fullChartParams:C,lineDirection:B,lengendItems:F,textSizePx:H}).pipe(c(o),h(async e=>e),f(e=>{const{width:t,height:i}=((s,n)=>{let u=0,x=0;if(!n.length||!n[0].length)return{width:u,height:x};const P=n[0][n[0].length-1];return s.lineDirection==="column"?(u=n.reduce((l,A)=>{const S=A.reduce((j,L)=>L.itemWidth>j?L.itemWidth:j,0);return l+S},0),u+=s.fullParams.gap*(n.length-1),x=P.translateY+s.textSizePx):(u=P.translateX+P.itemWidth,x=s.textSizePx*n.length+s.fullParams.gap*(n.length-1)),{width:u,height:x}})(e,e.lengendItems);return{direction:e.lineDirection,width:t,height:i,translateX:e.fullParams.gap,translateY:e.fullParams.gap}}),z(1)),te=a({fullParams:p,position:X,justify:U,lengendList:I}).pipe(c(o),h(async e=>e),f(e=>{const t=e.lengendList.width+e.fullParams.gap*2,i=e.lengendList.height+e.fullParams.gap*2;let s=0,n=0;return e.position==="left"?e.justify==="start"?(s=e.fullParams.padding,n=e.fullParams.padding):e.justify==="center"?(s=e.fullParams.padding,n=-i/2):e.justify==="end"&&(s=e.fullParams.padding,n=-i-e.fullParams.padding):e.position==="right"?e.justify==="start"?(s=-t-e.fullParams.padding,n=e.fullParams.padding):e.justify==="center"?(s=-t-e.fullParams.padding,n=-i/2):e.justify==="end"&&(s=-t-e.fullParams.padding,n=-i-e.fullParams.padding):e.position==="top"?e.justify==="start"?(s=e.fullParams.padding,n=e.fullParams.padding):e.justify==="center"?(s=-t/2,n=e.fullParams.padding):e.justify==="end"&&(s=-t-e.fullParams.padding,n=e.fullParams.padding):e.justify==="start"?(s=e.fullParams.padding,n=-i-e.fullParams.padding):e.justify==="center"?(s=-t/2,n=-i-e.fullParams.padding):e.justify==="end"&&(s=-t-e.fullParams.padding,n=-i-e.fullParams.padding),{width:t,height:i,translateX:s,translateY:n}})),ie=a({rootPositionSelection:_,fullParams:p,fullChartParams:C,legendCard:te}).pipe(c(o),h(async e=>e),f(e=>e.rootPositionSelection.selectAll("g").data([e.legendCard]).join(t=>t.append("g").classed(O,!0).attr("transform",i=>`translate(${i.translateX}, ${i.translateY})`),t=>t.transition().attr("transform",i=>`translate(${i.translateX}, ${i.translateY})`),t=>t.remove()).each((t,i,s)=>{k(s[i]).selectAll("rect").data([t]).join("rect").attr("width",n=>n.width).attr("height",n=>n.height).attr("fill",T(e.fullParams.backgroundFill,e.fullChartParams)).attr("stroke",T(e.fullParams.backgroundStroke,e.fullChartParams))}))),se=a({lengendCardSelection:ie,fullParams:p,lengendList:I}).pipe(c(o),h(async e=>e),f(e=>e.lengendCardSelection.selectAll("g").data([e.lengendList]).join(t=>t.append("g").classed(Q,!0).attr("transform",i=>`translate(${i.translateX}, ${i.translateY})`),t=>t.transition().attr("transform",i=>`translate(${i.translateX}, ${i.translateY})`),t=>t.remove())));return a({lengendListSelection:se,fullParams:p,fullChartParams:C,lengendItems:F,textSizePx:H}).pipe(c(o),h(async e=>e),f(e=>{const t=e.lengendItems[0]?e.lengendItems.flat():[];return e.lengendListSelection.selectAll(`g.${N}`).data(t).join(i=>i.append("g").classed(N,!0).attr("cursor","default"),i=>i,i=>i.remove()).attr("transform",(i,s)=>`translate(${i.translateX}, ${i.translateY})`).each((i,s,n)=>{const u=e.textSizePx/2,x=-i.listRectWidth/2,P=-i.listRectHeight/2;k(n[s]).selectAll("rect").data([i]).join("rect").attr("x",u).attr("y",u).attr("width",l=>l.listRectWidth).attr("height",l=>l.listRectHeight).attr("transform",l=>`translate(${x}, ${P})`).attr("fill",l=>l.color).attr("rx",l=>l.listRectRadius),k(n[s]).selectAll("text").data([i]).join(l=>l.append("text").attr("dominant-baseline","hanging"),l=>l,l=>l.remove()).attr("x",e.textSizePx*1.5).attr("font-size",e.fullChartParams.styles.textSize).attr("fill",l=>e.fullParams.textColorType==="series"?K(l.seriesIndex,e.fullChartParams):T(e.fullParams.textColorType,e.fullChartParams)).text(l=>l.text)})})).subscribe(),()=>{g.select(`g.${M}`).remove(),o.next(void 0)}};export{me as c};

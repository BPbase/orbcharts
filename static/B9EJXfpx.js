import{g as N,S as L,t as T,m as R,d as v,e as S,s as P,u as A,w as E,x as k,c as C,z,A as H,B as U,C as O,O as q,E as _}from"./BILlwXT2.js";import{b as F}from"./DPZ9Ss3w.js";import{f as V}from"./BQZk2i3U.js";function G(n,{text:s,radius:i,lineHeight:r,isBreakAll:o=!1,limit:u=0}){if(n==null||s==null){console.error("selection or text is not defined");return}i==null&&(i=n.node().getBBox().width/2);function l(a){let e;return o?e=a.split(""):e=a.split(/\s+/g),e[e.length-1]||e.pop(),e[0]||e.shift(),e}function f(a,e){return a&&e&&a.length>e&&(a=a.substring(0,e)+"..."),a}function p(a){var c;const e=document.createElement("canvas").getContext("2d");return((c=e==null?void 0:e.measureText(a))==null?void 0:c.width)??0}function b(a){const e=p(a.trim());return Math.sqrt(e*r)}function x(a,e){let c={width:0,text:""},g=1/0;const y=[];let D=" ";o&&(D="");for(let m=0,$=a.length;m<$;++m){const w=(c.text?c.text+D:"")+a[m],M=p(w);(g+M)/2<e?(c.width=g=M,c.text=w):(g=p(a[m]),c={width:g,text:a[m]},y.push(c))}return y}function t(a){let e=0;for(let c=0,g=a.length;c<g;++c){const y=(Math.abs(c-g/2+.5)+.5)*r,D=a[c].width/2;e=Math.max(e,Math.sqrt(D**2+y**2))}return e}function h(a,e){u>0&&(e=f(e,u));const c=l(e),g=b(e),y=x(c,g),D=t(y);let m=a.select("text");m.size()||(m=a.append("text")),m.attr("transform",`translate(0,0) scale(${i/D})`);const $=m.selectAll("tspan").data(y),w=$.enter().append("tspan").attr("x",0).merge($).attr("y",(M,W)=>(W-y.length/2+.8)*r).text(M=>M.text);return $.exit().remove(),$.merge(w)}return h(n,s)}let d;function J(n,s){return A().velocityDecay(s.force.velocityDecay).force("collision",E().radius(i=>i.r+s.force.collisionSpacing)).force("charge",k().strength(i=>-Math.pow(i.r,2)*s.force.strength)).on("tick",()=>{n.attr("transform",i=>`translate(${i.x},${i.y})`)})}function K({data:n,bubbleGroupR:s,maxValue:i,avgValue:r}){const o=s/Math.sqrt(n.length),l=o*o*Math.PI/r,f=i*l;return Math.pow(f/Math.PI,.5)*.75}function Q({data:n,LastBubbleDataMap:s,graphicWidth:i,graphicHeight:r,scaleType:o}){const u=Math.min(i,r)/2,l=n.flat().filter(a=>a.value!=null&&a.visible!=!1),f=Math.max(...l.map(a=>a.value)),p=l.reduce((a,e)=>a+(e.value??0),0)/l.length,b=K({data:l,bubbleGroupR:u,maxValue:f,avgValue:p}),x=o==="area"?.5:1,t=_().domain([0,f]).range([0,b]).exponent(x);return l.map(a=>{const e=a,c=s.get(a.id);c?(e.x=c.x,e.y=c.y):(e.x=Math.random()*i,e.y=Math.random()*r);const g=t(e.value??0);return e.r=g,e._originR=g,e})}function B({graphicSelection:n,bubblesData:s,fullParams:i}){let r=n.selectAll("g").data(s,l=>l.id),o=r.enter().append("g").attr("cursor","pointer");o.style("font-size",12).style("fill","#ffffff").attr("text-anchor","middle").attr("transform",l=>`translate(${l.x},${l.y})`),o.append("circle").attr("class","node").attr("cx",0).attr("cy",0).attr("fill",l=>l.color),o.append("text").style("opacity",.8).attr("pointer-events","none"),r.exit().remove();const u=r.merge(o);return u.select("circle").transition().duration(200).attr("r",l=>l.r).attr("fill",l=>l.color),u.each((l,f,p)=>{const b=C(p[f]);let x=!0;l.label.length<=i.bubbleText.lineLengthMin&&(x=!1),b.call(G,{text:l.label,radius:l.r*i.bubbleText.fillRate,lineHeight:i.bubbleText.lineHeight,isBreakAll:x})}),u}function X({data:n,highlightRIncrease:s,highlightIds:i}){if(s!=0){if(!i.length){n.forEach(r=>r.r=r._originR);return}n.forEach(r=>{i.includes(r.id)?r.r=r._originR+s:r.r=r._originR})}}function Y(){return z().on("start",(n,s)=>{n.active||d.alpha(1).restart(),s.fx=s.x,s.fy=s.y}).on("drag",(n,s)=>{n.active||d.alphaTarget(0),s.fx=n.x,s.fy=n.y}).on("end",(n,s)=>{s.fx=null,s.fy=null})}function I({fullParams:n,graphicWidth:s,graphicHeight:i}){d.force("x",H().strength(n.force.strength).x(0)).force("y",U().strength(n.force.strength).y(0)),d.alpha(1).restart()}function Z({bubblesSelection:n,highlightIds:s,fullChartParams:i}){if(n.interrupt("highlight"),!s.length){n.transition("highlight").style("opacity",1);return}n.each((r,o,u)=>{const l=C(u[o]);s.includes(r.id)?l.style("opacity",1).transition("highlight").ease(O).duration(500):l.style("opacity",i.styles.unhighlightedOpacity)})}const ae=N("Bubbles",F)(({selection:n,name:s,observer:i,subject:r})=>{const o=new L,u=n.append("g"),l=new L;let f=new Map;i.layout$.pipe(V()).subscribe(t=>{n.attr("transform",`translate(${t.width/2}, ${t.height/2})`),i.layout$.pipe(T(o)).subscribe(h=>{n.transition().attr("transform",`translate(${h.width/2}, ${h.height/2})`)})});const p=i.fullParams$.pipe(T(o),R(t=>t.bubbleScaleType),v()),b=new q(t=>{S({layout:i.layout$,computedData:i.computedData$,scaleType:p}).pipe(T(o),P(async h=>h)).subscribe(h=>{const a=Q({data:h.computedData,LastBubbleDataMap:f,graphicWidth:h.layout.width,graphicHeight:h.layout.height,scaleType:h.scaleType});t.next(a)})});b.subscribe(t=>{f=new Map(t.map(h=>[h.id,h]))});const x=i.fullChartParams$.pipe(T(o),R(t=>t.highlightTarget),v());return S({layout:i.layout$,computedData:i.computedData$,bubblesData:b,SeriesDataMap:i.SeriesDataMap$,fullParams:i.fullParams$,highlightTarget:x}).pipe(T(o),P(async t=>t)).subscribe(t=>{const h=B({graphicSelection:u,bubblesData:t.bubblesData,fullParams:t.fullParams});d=J(h,t.fullParams),h.on("mouseover",(a,e)=>{r.event$.next({type:"series",eventName:"mouseover",pluginName:s,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:a,data:t.computedData})}).on("mousemove",(a,e)=>{r.event$.next({type:"series",eventName:"mousemove",pluginName:s,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:a,data:t.computedData})}).on("mouseout",(a,e)=>{r.event$.next({type:"series",eventName:"mouseout",pluginName:s,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:a,data:t.computedData})}).on("click",(a,e)=>{r.event$.next({type:"series",eventName:"click",pluginName:s,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:a,data:t.computedData})}).call(Y()),d.nodes(t.bubblesData),I({fullParams:t.fullParams,graphicWidth:t.layout.width,graphicHeight:t.layout.height}),l.next(h)}),S({bubblesSelection:l,bubblesData:b,highlight:i.seriesHighlight$,fullChartParams:i.fullChartParams$,fullParams:i.fullParams$,layout:i.layout$}).pipe(T(o),P(async t=>t)).subscribe(t=>{Z({bubblesSelection:t.bubblesSelection,highlightIds:t.highlight,fullChartParams:t.fullChartParams}),t.fullParams.highlightRIncrease&&(X({data:t.bubblesData,highlightRIncrease:t.fullParams.highlightRIncrease,highlightIds:t.highlight}),B({graphicSelection:u,bubblesData:t.bubblesData,fullParams:t.fullParams})),I({fullParams:t.fullParams,graphicWidth:t.layout.width,graphicHeight:t.layout.height}),d.nodes(t.bubblesData)}),()=>{o.next(void 0)}});export{ae as B};

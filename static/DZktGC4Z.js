import{O as w,h as oe,S as B,t as l,m as u,d as $,e as d,s as x,c as A,y as ne,n as pe}from"./BpcKryD-.js";import{e as ce,a as ge,g as le}from"./fnY6dSo8.js";import{a as he}from"./4_nDscJ4.js";function ue(t){return new w(function(p){oe(t()).subscribe(p)})}function de(t,p,a){return ue(function(){return t()?p:a})}const j=.3;function me({axisWidth:t,groupAmount:p,barGroupPadding:a=0}){const h=t/(p-1)-a;return h>1?h:1}function be(t,p){return t<=1?0:p/(t-1)*j}function xe(t,p){return t<=1?p:p*(1-j)}function De({graphicGSelection:t,rectClassName:p,barData:a,zeroY:s,groupLabels:h,params:g,chartParams:G,barWidth:f,transformedBarRadius:P,delayGroup:y,transitionItem:M,isSeriesPositionSeprate:W}){const R=f/2;return t.each((z,L,I)=>{A(I[L]).selectAll(`rect.${p}`).data(a[L]??[],o=>o.id).join(o=>o.append("rect").classed(p,!0).attr("cursor","pointer").attr("height",c=>0),o=>o,o=>o.remove()).attr("transform",(o,c)=>`translate(${(o?o.axisX:0)-R}, 0)`).attr("fill",o=>o.color).attr("y",o=>s).attr("x",o=>0).attr("width",f).attr("rx",P[L][0]??1).attr("ry",P[L][1]??1).transition().duration(M).ease(ge(G.transitionEase)).delay((o,c)=>o.groupIndex*y).attr("y",o=>o._barStartY).attr("height",o=>Math.abs(o._barHeight))}),t.selectAll(`rect.${p}`)}function Se({defsSelection:t,clipPathData:p}){t.selectAll("clipPath").data(p).join(a=>a.append("clipPath"),a=>a,a=>a.remove()).attr("id",a=>a.id).each((a,s,h)=>{A(h[s]).selectAll("rect").data([a]).join(g=>g.append("rect"),g=>g,g=>g.remove()).attr("x",0).attr("y",0).attr("width",g=>g.width).attr("height",g=>g.height)})}function fe({selection:t,ids:p,fullChartParams:a}){if(t.interrupt("highlight"),!p.length){t.transition("highlight").duration(200).style("opacity",1);return}t.each((s,h,g)=>{p.includes(s.id)?A(g[h]).style("opacity",1):A(g[h]).style("opacity",a.styles.unhighlightedOpacity)})}const ye=(t,{selection:p,computedData$:a,visibleComputedData$:s,existSeriesLabels$:h,SeriesDataMap$:g,GroupDataMap$:G,fullParams$:f,fullDataFormatter$:P,fullChartParams$:y,gridAxesTransform$:M,gridGraphicTransform$:W,gridGraphicReverseScale$:R,gridAxesSize$:Y,gridHighlight$:z,gridContainer$:L,isSeriesPositionSeprate$:I,event$:o})=>{const c=new B,k=ce(t,"clipPath-box"),U=le(t,"rect"),{seriesSelection$:Le,axesSelection$:$e,defsSelection$:v,graphicGSelection$:K}=he({selection:p,pluginName:t,clipPathID:k,existSeriesLabels$:h,gridContainer$:L,gridAxesTransform$:M,gridGraphicTransform$:W}),F=s.pipe(l(c),u(e=>e[0]&&e[0][0]?e[0][0].axisY-e[0][0].axisYFromZero:0),$()),_=d({computedData:a,params:f,axisSize:Y,isSeriesPositionSeprate:I}).pipe(l(c),x(async e=>e),u(e=>e.params.barWidth?e.params.barWidth:me({axisWidth:e.axisSize.width,groupAmount:e.computedData[0]?e.computedData[0].length:0,barGroupPadding:e.params.barGroupPadding})),$()),X=d({computedData:a,barWidth:_,params:f,gridGraphicReverseScale:R}).pipe(l(c),x(async e=>e),u(e=>{const i=e.barWidth/2,n=e.params.barRadius===!0?i:e.params.barRadius===!1?0:typeof e.params.barRadius=="number"?e.params.barRadius:0;return e.computedData.map((r,D)=>{const m=e.gridGraphicReverseScale[D]??e.gridGraphicReverseScale[0],S=n*m[0],b=n*m[1];return[S,b]})})),T=s.pipe(l(c),u(e=>{const i=new Set;return e.forEach(n=>{n.forEach(r=>{i.add(r.groupLabel)})}),Array.from(i)})),C=y.pipe(l(c),u(e=>e.transitionDuration),$()),q=new w(e=>{d({groupLabels:T,transitionDuration:C}).pipe(x(async i=>i)).subscribe(i=>{const n=be(i.groupLabels.length,i.transitionDuration);e.next(n)})}).pipe(l(c),$()),J=new w(e=>{d({groupLabels:T,transitionDuration:C}).pipe(x(async i=>i)).subscribe(i=>{const n=xe(i.groupLabels.length,i.transitionDuration);e.next(n)})}).pipe(l(c),$()),Q=d({computedData:a,dataFormatter:P}).pipe(l(c),x(async e=>e),u(e=>{const n=e.computedData[0]?e.computedData[0].length-1:0,r=e.dataFormatter.grid.groupAxis.scaleDomain[0]==="auto"?0-e.dataFormatter.grid.groupAxis.scalePadding:e.dataFormatter.grid.groupAxis.scaleDomain[0]-e.dataFormatter.grid.groupAxis.scalePadding,D=e.dataFormatter.grid.groupAxis.scaleDomain[1]==="auto"?n+e.dataFormatter.grid.groupAxis.scalePadding:e.dataFormatter.grid.groupAxis.scaleDomain[1]+e.dataFormatter.grid.groupAxis.scalePadding,m=e.computedData.map(S=>S.filter((b,E)=>b.groupIndex>=r&&b.groupIndex<=D));if(m.length<=1)return 1;{const S=m.flat().map(O=>O.axisYFromZero),b=Math.max(...S),E=e.computedData[0]?e.computedData[0].map((O,ie)=>e.computedData.reduce((ae,se)=>ae+se[ie].axisYFromZero,0)):[],te=Math.max(...E);return b/te}})),V=d({computedData:a,yRatio:Q,zeroY:F}).pipe(l(c),u(e=>{let i=e.computedData[0]?e.computedData[0].map(()=>e.zeroY):[];return e.computedData.map((n,r)=>n.map((D,m)=>{const S=i[m],b=D.axisYFromZero*e.yRatio;return i[m]=i[m]+b,{...D,_barStartY:S,_barHeight:b}}))})),N=d({computedData:a,zeroY:F}).pipe(l(c),u(e=>e.computedData.map((i,n)=>i.map((r,D)=>({...r,_barStartY:e.zeroY,_barHeight:r.axisYFromZero}))))),ee=I.pipe(x(e=>de(()=>e,N,V)));d({defsSelection:v,gridAxesSize:Y}).pipe(l(c),x(async e=>e)).subscribe(e=>{const i=[{id:k,width:e.gridAxesSize.width,height:e.gridAxesSize.height}];Se({defsSelection:e.defsSelection,clipPathData:i})});const re=y.pipe(l(c),u(e=>e.highlightTarget),$()),H=new B;return d({graphicGSelection:K,graphicData:ee,zeroY:F,groupLabels:T,params:f,chartParams:y,highlightTarget:re,barWidth:_,transformedBarRadius:X,delayGroup:q,transitionItem:J,SeriesDataMap:g,GroupDataMap:G,isSeriesPositionSeprate:I}).pipe(l(c),x(async e=>e)).subscribe(e=>{const i=De({graphicGSelection:e.graphicGSelection,rectClassName:U,barData:e.graphicData,zeroY:e.zeroY,groupLabels:e.groupLabels,params:e.params,chartParams:e.chartParams,barWidth:e.barWidth,transformedBarRadius:e.transformedBarRadius,delayGroup:e.delayGroup,transitionItem:e.transitionItem,isSeriesPositionSeprate:e.isSeriesPositionSeprate});i.on("mouseover",(n,r)=>{n.stopPropagation(),o.next({type:"grid",eventName:"mouseover",pluginName:t,highlightTarget:e.highlightTarget,datum:r,gridIndex:r.gridIndex,series:e.SeriesDataMap.get(r.seriesLabel),seriesIndex:r.seriesIndex,seriesLabel:r.seriesLabel,groups:e.GroupDataMap.get(r.groupLabel),groupIndex:r.groupIndex,groupLabel:r.groupLabel,event:n,data:e.graphicData})}).on("mousemove",(n,r)=>{n.stopPropagation(),o.next({type:"grid",eventName:"mousemove",pluginName:t,highlightTarget:e.highlightTarget,datum:r,gridIndex:r.gridIndex,series:e.SeriesDataMap.get(r.seriesLabel),seriesIndex:r.seriesIndex,seriesLabel:r.seriesLabel,groups:e.GroupDataMap.get(r.groupLabel),groupIndex:r.groupIndex,groupLabel:r.groupLabel,event:n,data:e.graphicData})}).on("mouseout",(n,r)=>{n.stopPropagation(),o.next({type:"grid",eventName:"mouseout",pluginName:t,highlightTarget:e.highlightTarget,datum:r,gridIndex:r.gridIndex,series:e.SeriesDataMap.get(r.seriesLabel),seriesIndex:r.seriesIndex,seriesLabel:r.seriesLabel,groups:e.GroupDataMap.get(r.groupLabel),groupIndex:r.groupIndex,groupLabel:r.groupLabel,event:n,data:e.graphicData})}).on("click",(n,r)=>{n.stopPropagation(),o.next({type:"grid",eventName:"click",pluginName:t,highlightTarget:e.highlightTarget,datum:r,gridIndex:r.gridIndex,series:e.SeriesDataMap.get(r.seriesLabel),seriesIndex:r.seriesIndex,seriesLabel:r.seriesLabel,groups:e.GroupDataMap.get(r.groupLabel),groupIndex:r.groupIndex,groupLabel:r.groupLabel,event:n,data:e.graphicData})}),H.next(i)}),d({barSelection:H,highlight:z.pipe(u(e=>e.map(i=>i.id))),fullChartParams:y}).pipe(l(c),x(async e=>e)).subscribe(e=>{fe({selection:e.barSelection,ids:e.highlight,fullChartParams:e.fullChartParams})}),()=>{c.next(void 0)}},Z="BarStack",Ge=ne(Z,pe)(({selection:t,name:p,subject:a,observer:s})=>{const h=new B,g=ye(Z,{selection:t,computedData$:s.computedData$,visibleComputedData$:s.visibleComputedData$,existSeriesLabels$:s.existSeriesLabels$,SeriesDataMap$:s.SeriesDataMap$,GroupDataMap$:s.GroupDataMap$,fullParams$:s.fullParams$,fullDataFormatter$:s.fullDataFormatter$,fullChartParams$:s.fullChartParams$,gridAxesTransform$:s.gridAxesTransform$,gridGraphicTransform$:s.gridGraphicTransform$,gridGraphicReverseScale$:s.gridGraphicReverseScale$,gridAxesSize$:s.gridAxesSize$,gridHighlight$:s.gridHighlight$,gridContainer$:s.gridContainer$,isSeriesPositionSeprate$:s.isSeriesPositionSeprate$,event$:a.event$});return()=>{h.next(void 0),g()}});export{Ge as B,ye as c,de as i};

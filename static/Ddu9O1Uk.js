import{O as w,j as oe,S as B,t as l,m as b,e as $,f as h,s as x,c as G,d as ne,q as pe}from"./Czm2CNpZ.js";import{e as ce,a as ge,g as le}from"./CB2cfhTk.js";import{a as ue}from"./CgW5LUy5.js";function he(t){return new w(function(p){oe(t()).subscribe(p)})}function de(t,p,i){return he(function(){return t()?p:i})}const Z=.3;function me({axisWidth:t,groupAmount:p,barGroupPadding:i=0}){const u=t/(p-1)-i;return u>1?u:1}function be(t,p){return t<=1?0:p/(t-1)*Z}function xe(t,p){return t<=1?p:p*(1-Z)}function De({graphicGSelection:t,rectClassName:p,barData:i,zeroY:s,groupLabels:u,params:g,chartParams:M,barWidth:f,transformedBarRadius:A,delayGroup:y,transitionItem:I,isSeriesPositionSeprate:W}){const R=f/2;return t.each((z,L,P)=>{G(P[L]).selectAll(`rect.${p}`).data(i[L]??[],o=>o.id).join(o=>o.append("rect").classed(p,!0).attr("cursor","pointer").attr("height",c=>0),o=>o,o=>o.remove()).attr("transform",(o,c)=>`translate(${(o?o.axisX:0)-R}, 0)`).attr("fill",o=>o.color).attr("y",o=>s).attr("x",o=>0).attr("width",f).attr("rx",A[L][0]??1).attr("ry",A[L][1]??1).transition().duration(I).ease(ge(M.transitionEase)).delay((o,c)=>o.groupIndex*y).attr("y",o=>o._barStartY).attr("height",o=>Math.abs(o._barHeight))}),t.selectAll(`rect.${p}`)}function Se({defsSelection:t,clipPathData:p}){t.selectAll("clipPath").data(p).join(i=>i.append("clipPath"),i=>i,i=>i.remove()).attr("id",i=>i.id).each((i,s,u)=>{G(u[s]).selectAll("rect").data([i]).join(g=>g.append("rect"),g=>g,g=>g.remove()).attr("x",0).attr("y",0).attr("width",g=>g.width).attr("height",g=>g.height)})}function fe({selection:t,ids:p,fullChartParams:i}){if(t.interrupt("highlight"),!p.length){t.transition("highlight").duration(200).style("opacity",1);return}t.each((s,u,g)=>{p.includes(s.id)?G(g[u]).style("opacity",1):G(g[u]).style("opacity",i.styles.unhighlightedOpacity)})}const ye=(t,{selection:p,computedData$:i,visibleComputedData$:s,existedSeriesLabels$:u,SeriesDataMap$:g,GroupDataMap$:M,fullParams$:f,fullDataFormatter$:A,fullChartParams$:y,gridAxesTransform$:I,gridGraphicTransform$:W,gridGraphicReverseScale$:R,gridAxesSize$:Y,gridHighlight$:z,gridContainer$:L,isSeriesPositionSeprate$:P,event$:o})=>{const c=new B,k=ce(t,"clipPath-box"),U=le(t,"rect"),{seriesSelection$:Le,axesSelection$:$e,defsSelection$:v,graphicGSelection$:q}=ue({selection:p,pluginName:t,clipPathID:k,existedSeriesLabels$:u,gridContainer$:L,gridAxesTransform$:I,gridGraphicTransform$:W}),F=s.pipe(l(c),b(e=>e[0]&&e[0][0]?e[0][0].axisY-e[0][0].axisYFromZero:0),$()),_=h({computedData:i,params:f,axisSize:Y,isSeriesPositionSeprate:P}).pipe(l(c),x(async e=>e),b(e=>e.params.barWidth?e.params.barWidth:me({axisWidth:e.axisSize.width,groupAmount:e.computedData[0]?e.computedData[0].length:0,barGroupPadding:e.params.barGroupPadding})),$()),K=h({computedData:i,barWidth:_,params:f,gridGraphicReverseScale:R}).pipe(l(c),x(async e=>e),b(e=>{const a=e.barWidth/2,n=e.params.barRadius===!0?a:e.params.barRadius===!1?0:typeof e.params.barRadius=="number"?e.params.barRadius:0;return e.computedData.map((r,D)=>{const d=e.gridGraphicReverseScale[D]??e.gridGraphicReverseScale[0],S=n*d[0],m=n*d[1];return[S,m]})})),T=s.pipe(l(c),b(e=>{const a=new Set;return e.forEach(n=>{n.forEach(r=>{a.add(r.groupLabel)})}),Array.from(a)})),C=y.pipe(l(c),b(e=>e.transitionDuration),$()),X=new w(e=>{h({groupLabels:T,transitionDuration:C}).pipe(x(async a=>a)).subscribe(a=>{const n=be(a.groupLabels.length,a.transitionDuration);e.next(n)})}).pipe(l(c),$()),J=new w(e=>{h({groupLabels:T,transitionDuration:C}).pipe(x(async a=>a)).subscribe(a=>{const n=xe(a.groupLabels.length,a.transitionDuration);e.next(n)})}).pipe(l(c),$()),Q=h({computedData:i,dataFormatter:A}).pipe(l(c),x(async e=>e),b(e=>{const n=e.computedData[0]?e.computedData[0].length-1:0,r=e.dataFormatter.grid.groupAxis.scaleDomain[0]==="auto"?0-e.dataFormatter.grid.groupAxis.scalePadding:e.dataFormatter.grid.groupAxis.scaleDomain[0]-e.dataFormatter.grid.groupAxis.scalePadding,D=e.dataFormatter.grid.groupAxis.scaleDomain[1]==="auto"?n+e.dataFormatter.grid.groupAxis.scalePadding:e.dataFormatter.grid.groupAxis.scaleDomain[1]+e.dataFormatter.grid.groupAxis.scalePadding,d=e.computedData.map(S=>S.filter((m,j)=>m.groupIndex>=r&&m.groupIndex<=D));if(d.length<=1)return 1;{const S=d.flat().map(E=>E.axisYFromZero),m=Math.max(...S),j=e.computedData[0]?e.computedData[0].map((E,ae)=>e.computedData.reduce((ie,se)=>ie+se[ae].axisYFromZero,0)):[],te=Math.max(...j);return m/te}})),V=h({computedData:i,yRatio:Q,zeroY:F}).pipe(l(c),b(e=>{let a=e.computedData[0]?e.computedData[0].map(()=>e.zeroY):[];return e.computedData.map((n,r)=>n.map((D,d)=>{const S=a[d],m=D.axisYFromZero*e.yRatio;return a[d]=a[d]+m,{...D,_barStartY:S,_barHeight:m}}))})),N=h({computedData:i,zeroY:F}).pipe(l(c),b(e=>e.computedData.map((a,n)=>a.map((r,D)=>({...r,_barStartY:e.zeroY,_barHeight:r.axisYFromZero}))))),ee=P.pipe(x(e=>de(()=>e,N,V)));h({defsSelection:v,gridAxesSize:Y}).pipe(l(c),x(async e=>e)).subscribe(e=>{const a=[{id:k,width:e.gridAxesSize.width,height:e.gridAxesSize.height}];Se({defsSelection:e.defsSelection,clipPathData:a})});const re=y.pipe(l(c),b(e=>e.highlightTarget),$()),H=new B;return h({graphicGSelection:q,graphicData:ee,zeroY:F,groupLabels:T,params:f,chartParams:y,highlightTarget:re,barWidth:_,transformedBarRadius:K,delayGroup:X,transitionItem:J,SeriesDataMap:g,GroupDataMap:M,isSeriesPositionSeprate:P}).pipe(l(c),x(async e=>e)).subscribe(e=>{const a=De({graphicGSelection:e.graphicGSelection,rectClassName:U,barData:e.graphicData,zeroY:e.zeroY,groupLabels:e.groupLabels,params:e.params,chartParams:e.chartParams,barWidth:e.barWidth,transformedBarRadius:e.transformedBarRadius,delayGroup:e.delayGroup,transitionItem:e.transitionItem,isSeriesPositionSeprate:e.isSeriesPositionSeprate});a.on("mouseover",(n,r)=>{n.stopPropagation(),o.next({type:"grid",eventName:"mouseover",pluginName:t,highlightTarget:e.highlightTarget,datum:r,series:e.SeriesDataMap.get(r.seriesLabel),seriesIndex:r.seriesIndex,seriesLabel:r.seriesLabel,groups:e.GroupDataMap.get(r.groupLabel),groupIndex:r.groupIndex,groupLabel:r.groupLabel,event:n,data:e.graphicData})}).on("mousemove",(n,r)=>{n.stopPropagation(),o.next({type:"grid",eventName:"mousemove",pluginName:t,highlightTarget:e.highlightTarget,datum:r,series:e.SeriesDataMap.get(r.seriesLabel),seriesIndex:r.seriesIndex,seriesLabel:r.seriesLabel,groups:e.GroupDataMap.get(r.groupLabel),groupIndex:r.groupIndex,groupLabel:r.groupLabel,event:n,data:e.graphicData})}).on("mouseout",(n,r)=>{n.stopPropagation(),o.next({type:"grid",eventName:"mouseout",pluginName:t,highlightTarget:e.highlightTarget,datum:r,series:e.SeriesDataMap.get(r.seriesLabel),seriesIndex:r.seriesIndex,seriesLabel:r.seriesLabel,groups:e.GroupDataMap.get(r.groupLabel),groupIndex:r.groupIndex,groupLabel:r.groupLabel,event:n,data:e.graphicData})}).on("click",(n,r)=>{n.stopPropagation(),o.next({type:"grid",eventName:"click",pluginName:t,highlightTarget:e.highlightTarget,datum:r,series:e.SeriesDataMap.get(r.seriesLabel),seriesIndex:r.seriesIndex,seriesLabel:r.seriesLabel,groups:e.GroupDataMap.get(r.groupLabel),groupIndex:r.groupIndex,groupLabel:r.groupLabel,event:n,data:e.graphicData})}),H.next(a)}),h({barSelection:H,highlight:z,fullChartParams:y}).pipe(l(c),x(async e=>e)).subscribe(e=>{fe({selection:e.barSelection,ids:e.highlight,fullChartParams:e.fullChartParams})}),()=>{c.next(void 0)}},O="BarStack",Me=ne(O,pe)(({selection:t,name:p,subject:i,observer:s})=>{const u=new B,g=ye(O,{selection:t,computedData$:s.computedData$,visibleComputedData$:s.visibleComputedData$,existedSeriesLabels$:s.existedSeriesLabels$,SeriesDataMap$:s.SeriesDataMap$,GroupDataMap$:s.GroupDataMap$,fullParams$:s.fullParams$,fullDataFormatter$:s.fullDataFormatter$,fullChartParams$:s.fullChartParams$,gridAxesTransform$:s.gridAxesTransform$,gridGraphicTransform$:s.gridGraphicTransform$,gridGraphicReverseScale$:s.gridGraphicReverseScale$,gridAxesSize$:s.gridAxesSize$,gridHighlight$:s.gridHighlight$,gridContainer$:s.gridContainer$,isSeriesPositionSeprate$:s.isSeriesPositionSeprate$,event$:i.event$});return()=>{u.next(void 0),g()}});export{Me as B,ye as c,de as i};

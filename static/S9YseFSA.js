import{ad as $,S as P,m as f,b as T,t as y,k as m,l as x,c as d,B,L as C,aI as I,s as L,aF as v,aJ as N,aK as R,aL as w,aG as A,aM as k,aN as F,aO as H}from"./CJz0rwbW.js";import{a as _}from"./DdT0iQQs.js";const E="Bubbles",O={name:E,defaultParams:B,layerIndex:C,validator:(r,{validateColumns:s})=>{const t=s(r,{force:{toBeTypes:["object"]},bubbleText:{toBeTypes:["object"]},arcScaleType:{toBe:'"area" | "radius"',test:l=>l==="area"||l==="radius"}});if(r.force){const l=s(r.force,{velocityDecay:{toBeTypes:["number"]},collisionSpacing:{toBeTypes:["number"]},strength:{toBeTypes:["number"]}});if(l.status==="error")return l}if(r.bubbleText){const l=s(r.bubbleText,{fillRate:{toBeTypes:["number"]},lineHeight:{toBeTypes:["number"]},lineLengthMin:{toBeTypes:["number"]}});if(l.status==="error")return l}return t}};let p;function U(r,s){return N().velocityDecay(s.force.velocityDecay).force("collision",R().radius(t=>t.r+s.force.collisionSpacing)).force("charge",w().strength(t=>-Math.pow(t.r,2)*s.force.strength)).on("tick",()=>{r.attr("transform",t=>`translate(${t.x},${t.y})`)})}function j({visibleComputedLayoutData:r,LastBubbleDataMap:s,graphicWidth:t,graphicHeight:l,SeriesContainerPositionMap:o,scaleType:u}){const a=Math.min(t,l)/2,c=r.flat(),h=c.reduce((n,i)=>n+i.value,0),b=A().domain([0,h]).range([0,a]).exponent(u==="area"?.5:1),g=u==="area"?1:(()=>{const n=a*a*Math.PI;return Math.sqrt(n/k(c,i=>Math.PI*Math.pow(b(i.value),2)))})(),e=.9;return c.map(n=>{const i=n,S=s.get(i.id);if(S)i.x=S.x,i.y=S.y;else{const M=o.get(i.seriesLabel);i.x=Math.random()*M.width,i.y=Math.random()*M.height}const D=b(i.value??0)*g*e;return i.r=D,i._originR=D,i})}function G({selection:r,bubblesData:s,fullParams:t,sumSeries:l}){const o=r.selectAll("g").data(s,a=>a.id).join(a=>{const c=a.append("g").attr("cursor","pointer").attr("font-size",12).style("fill","#ffffff").attr("text-anchor","middle");return c.append("circle").attr("class","node").attr("cx",0).attr("cy",0).attr("fill",h=>h.color),c.append("text").style("opacity",.8).attr("pointer-events","none"),c},a=>a,a=>a.remove()).attr("transform",a=>`translate(${a.x},${a.y})`),u=l?"seriesLabel":"label";return o.select("circle").transition().duration(200).attr("r",a=>a.r).attr("fill",a=>a.color),o.each((a,c,h)=>{const b=L(h[c]);let g=!0;a[u].length<=t.bubbleText.lineLengthMin&&(g=!1),b.call(_,{text:a[u],radius:a.r*t.bubbleText.fillRate,lineHeight:t.bubbleText.lineHeight,isBreakAll:g})}),o}function X(){return I().on("start",(r,s)=>{r.active||p.alpha(1).restart(),s.fx=s.x,s.fy=s.y}).on("drag",(r,s)=>{r.active||p.alphaTarget(0),s.fx=r.x,s.fy=r.y}).on("end",(r,s)=>{s.fx=null,s.fy=null})}function Y({fullParams:r,SeriesContainerPositionMap:s}){p.force("x",F().strength(r.force.strength).x(t=>s.get(t.seriesLabel).centerX)).force("y",H().strength(r.force.strength).y(t=>s.get(t.seriesLabel).centerY)),p.alpha(1).restart()}function q({bubblesSelection:r,highlightIds:s,fullChartParams:t}){if(r.interrupt("highlight"),!s.length){r.transition("highlight").style("opacity",1);return}r.each((l,o,u)=>{const a=L(u[o]);s.includes(l.id)?a.style("opacity",1).transition("highlight").ease(v).duration(500):a.style("opacity",t.styles.unhighlightedOpacity)})}const K=$(O)(({selection:r,name:s,observer:t,subject:l})=>{const o=new P;let u=new Map;const a=t.fullDataFormatter$.pipe(f(e=>e.sumSeries),T()),c=t.fullParams$.pipe(y(o),f(e=>e.arcScaleType),T()),h=m({layout:t.layout$,SeriesContainerPositionMap:t.SeriesContainerPositionMap$,visibleComputedLayoutData:t.visibleComputedLayoutData$,scaleType:c}).pipe(y(o),x(async e=>e),f(e=>j({visibleComputedLayoutData:e.visibleComputedLayoutData,LastBubbleDataMap:u,graphicWidth:e.layout.width,graphicHeight:e.layout.height,SeriesContainerPositionMap:e.SeriesContainerPositionMap,scaleType:e.scaleType})),d(1));h.subscribe(e=>{u=new Map(e.map(n=>[n.id,n]))});const b=t.fullChartParams$.pipe(y(o),f(e=>e.highlightTarget),T()),g=m({bubblesData:h,fullParams:t.fullParams$,SeriesContainerPositionMap:t.SeriesContainerPositionMap$,sumSeries:a}).pipe(y(o),x(async e=>e),f(e=>{p&&p.stop();const n=G({selection:r,bubblesData:e.bubblesData,fullParams:e.fullParams,sumSeries:e.sumSeries});return p=U(n,e.fullParams),p.nodes(e.bubblesData),Y({fullParams:e.fullParams,SeriesContainerPositionMap:e.SeriesContainerPositionMap}),n}));return m({bubblesSelection:g,computedData:t.computedData$,SeriesDataMap:t.SeriesDataMap$,highlightTarget:b}).pipe(y(o),x(async e=>e)).subscribe(e=>{e.bubblesSelection.on("mouseover",(n,i)=>{l.event$.next({type:"series",eventName:"mouseover",pluginName:s,highlightTarget:e.highlightTarget,datum:i,series:e.SeriesDataMap.get(i.seriesLabel),seriesIndex:i.seriesIndex,seriesLabel:i.seriesLabel,event:n,data:e.computedData})}).on("mousemove",(n,i)=>{l.event$.next({type:"series",eventName:"mousemove",pluginName:s,highlightTarget:e.highlightTarget,datum:i,series:e.SeriesDataMap.get(i.seriesLabel),seriesIndex:i.seriesIndex,seriesLabel:i.seriesLabel,event:n,data:e.computedData})}).on("mouseout",(n,i)=>{l.event$.next({type:"series",eventName:"mouseout",pluginName:s,highlightTarget:e.highlightTarget,datum:i,series:e.SeriesDataMap.get(i.seriesLabel),seriesIndex:i.seriesIndex,seriesLabel:i.seriesLabel,event:n,data:e.computedData})}).on("click",(n,i)=>{l.event$.next({type:"series",eventName:"click",pluginName:s,highlightTarget:e.highlightTarget,datum:i,series:e.SeriesDataMap.get(i.seriesLabel),seriesIndex:i.seriesIndex,seriesLabel:i.seriesLabel,event:n,data:e.computedData})}).call(X())}),m({bubblesSelection:g,bubblesData:h,highlight:t.seriesHighlight$.pipe(f(e=>e.map(n=>n.id))),fullChartParams:t.fullChartParams$,fullParams:t.fullParams$,sumSeries:a,SeriesContainerPositionMap:t.SeriesContainerPositionMap$}).pipe(y(o),x(async e=>e)).subscribe(e=>{q({bubblesSelection:e.bubblesSelection,highlightIds:e.highlight,fullChartParams:e.fullChartParams})}),()=>{o.next(void 0)}});export{K as B};

import{D as I,y as A,S as N,m as D,d as B,t as $,c as C,b as P,j as R,z as W,s as v,u as k,A as F,B as E,C as U,v as q,E as z,F as H,G as O}from"./Bj-Bl9V3.js";function _(r,{text:a,radius:s,lineHeight:u,isBreakAll:c=!1,limit:h=0}){if(r==null||a==null){console.error("selection or text is not defined");return}s==null&&(s=r.node().getBBox().width/2);function n(e){let i;return c?i=e.split(""):i=e.split(/\s+/g),i[i.length-1]||i.pop(),i[0]||i.shift(),i}function g(e,i){return e&&i&&e.length>i&&(e=e.substring(0,i)+"..."),e}function p(e){var o;const i=document.createElement("canvas").getContext("2d");return((o=i==null?void 0:i.measureText(e))==null?void 0:o.width)??0}function y(e){const i=p(e.trim());return Math.sqrt(i*u)}function m(e,i){let o={width:0,text:""},f=1/0;const x=[];let S=" ";c&&(S="");for(let b=0,M=e.length;b<M;++b){const T=(o.text?o.text+S:"")+e[b],L=p(T);(f+L)/2<i?(o.width=f=L,o.text=T):(f=p(e[b]),o={width:f,text:e[b]},x.push(o))}return x}function t(e){let i=0;for(let o=0,f=e.length;o<f;++o){const x=(Math.abs(o-f/2+.5)+.5)*u,S=e[o].width/2;i=Math.max(i,Math.sqrt(S**2+x**2))}return i}function l(e,i){h>0&&(i=g(i,h));const o=n(i),f=y(i),x=m(o,f),S=t(x);let b=e.select("text");b.size()||(b=e.append("text")),b.attr("transform",`translate(0,0) scale(${s/S})`);const M=b.selectAll("tspan").data(x),T=M.enter().append("tspan").attr("x",0).merge(M).attr("y",(L,w)=>(w-x.length/2+.8)*u).text(L=>L.text);return M.exit().remove(),M.merge(T)}return l(r,a)}let d;function j(r,a){return F().velocityDecay(a.force.velocityDecay).force("collision",E().radius(s=>s.r+a.force.collisionSpacing)).force("charge",U().strength(s=>-Math.pow(s.r,2)*a.force.strength)).on("tick",()=>{r.attr("transform",s=>`translate(${s.x},${s.y})`)})}function G({visibleComputedLayoutData:r,LastBubbleDataMap:a,graphicWidth:s,graphicHeight:u,SeriesContainerPositionMap:c,scaleType:h}){const n=Math.min(s,u)/2,g=r.flat(),p=g.reduce((l,e)=>l+e.value,0),y=q().domain([0,p]).range([0,n]).exponent(h==="area"?.5:1),m=h==="area"?1:(()=>{const l=n*n*Math.PI;return Math.sqrt(l/z(g,e=>Math.PI*Math.pow(y(e.value),2)))})(),t=.9;return g.map(l=>{const e=l,i=a.get(e.id);if(i)e.x=i.x,e.y=i.y;else{const f=c.get(e.seriesLabel);e.x=Math.random()*f.width,e.y=Math.random()*f.height}const o=y(e.value??0)*m*t;return e.r=o,e._originR=o,e})}function V({selection:r,bubblesData:a,fullParams:s,sumSeries:u}){const c=r.selectAll("g").data(a,n=>n.id).join(n=>{const g=n.append("g").attr("cursor","pointer").attr("font-size",12).style("fill","#ffffff").attr("text-anchor","middle");return g.append("circle").attr("class","node").attr("cx",0).attr("cy",0).attr("fill",p=>p.color),g.append("text").style("opacity",.8).attr("pointer-events","none"),g},n=>n,n=>n.remove()).attr("transform",n=>`translate(${n.x},${n.y})`),h=u?"seriesLabel":"label";return c.select("circle").transition().duration(200).attr("r",n=>n.r).attr("fill",n=>n.color),c.each((n,g,p)=>{const y=v(p[g]);let m=!0;n[h].length<=s.bubbleText.lineLengthMin&&(m=!1),y.call(_,{text:n[h],radius:n.r*s.bubbleText.fillRate,lineHeight:s.bubbleText.lineHeight,isBreakAll:m})}),c}function X(){return W().on("start",(r,a)=>{r.active||d.alpha(1).restart(),a.fx=a.x,a.fy=a.y}).on("drag",(r,a)=>{r.active||d.alphaTarget(0),a.fx=r.x,a.fy=r.y}).on("end",(r,a)=>{a.fx=null,a.fy=null})}function Y({fullParams:r,SeriesContainerPositionMap:a}){d.force("x",H().strength(r.force.strength).x(s=>a.get(s.seriesLabel).centerX)).force("y",O().strength(r.force.strength).y(s=>a.get(s.seriesLabel).centerY)),d.alpha(1).restart()}function J({bubblesSelection:r,highlightIds:a,fullChartParams:s}){if(r.interrupt("highlight"),!a.length){r.transition("highlight").style("opacity",1);return}r.each((u,c,h)=>{const n=v(h[c]);a.includes(u.id)?n.style("opacity",1).transition("highlight").ease(k).duration(500):n.style("opacity",s.styles.unhighlightedOpacity)})}const Q=I("Bubbles",A)(({selection:r,name:a,observer:s,subject:u})=>{const c=new N;let h=new Map;const n=s.fullDataFormatter$.pipe(D(t=>t.sumSeries),B()),g=s.fullParams$.pipe($(c),D(t=>t.arcScaleType),B()),p=C({layout:s.layout$,SeriesContainerPositionMap:s.SeriesContainerPositionMap$,visibleComputedLayoutData:s.visibleComputedLayoutData$,scaleType:g}).pipe($(c),P(async t=>t),D(t=>G({visibleComputedLayoutData:t.visibleComputedLayoutData,LastBubbleDataMap:h,graphicWidth:t.layout.width,graphicHeight:t.layout.height,SeriesContainerPositionMap:t.SeriesContainerPositionMap,scaleType:t.scaleType})),R(1));p.subscribe(t=>{h=new Map(t.map(l=>[l.id,l]))});const y=s.fullChartParams$.pipe($(c),D(t=>t.highlightTarget),B()),m=C({bubblesData:p,fullParams:s.fullParams$,SeriesContainerPositionMap:s.SeriesContainerPositionMap$,sumSeries:n}).pipe($(c),P(async t=>t),D(t=>{d&&d.stop();const l=V({selection:r,bubblesData:t.bubblesData,fullParams:t.fullParams,sumSeries:t.sumSeries});return d=j(l,t.fullParams),d.nodes(t.bubblesData),Y({fullParams:t.fullParams,SeriesContainerPositionMap:t.SeriesContainerPositionMap}),l}));return C({bubblesSelection:m,computedData:s.computedData$,SeriesDataMap:s.SeriesDataMap$,highlightTarget:y}).pipe($(c),P(async t=>t)).subscribe(t=>{t.bubblesSelection.on("mouseover",(l,e)=>{u.event$.next({type:"series",eventName:"mouseover",pluginName:a,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:l,data:t.computedData})}).on("mousemove",(l,e)=>{u.event$.next({type:"series",eventName:"mousemove",pluginName:a,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:l,data:t.computedData})}).on("mouseout",(l,e)=>{u.event$.next({type:"series",eventName:"mouseout",pluginName:a,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:l,data:t.computedData})}).on("click",(l,e)=>{u.event$.next({type:"series",eventName:"click",pluginName:a,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:l,data:t.computedData})}).call(X())}),C({bubblesSelection:m,bubblesData:p,highlight:s.seriesHighlight$.pipe(D(t=>t.map(l=>l.id))),fullChartParams:s.fullChartParams$,fullParams:s.fullParams$,sumSeries:n,SeriesContainerPositionMap:s.SeriesContainerPositionMap$}).pipe($(c),P(async t=>t)).subscribe(t=>{J({bubblesSelection:t.bubblesSelection,highlightIds:t.highlight,fullChartParams:t.fullChartParams})}),()=>{c.next(void 0)}});export{Q as B};

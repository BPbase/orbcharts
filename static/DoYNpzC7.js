import{aX as J,a3 as U,a7 as A,ad as F,a9 as H,aa as k,ah as q,a8 as $,a6 as W,aY as V,A as G,aZ as X,a_ as _,V as Y,S as j,t as y,m as x,W as Z,o as T,p as S,h as K,s as L}from"./B90BryHn.js";import{c as Q}from"./CeP_Z5Ml.js";import{r as tt,s as at,t as et,h as v,g as B}from"./VvZonOBc.js";import{o as rt}from"./fbVbHJU8.js";const lt=g=>{const{data:l=[],dataFormatter:n,chartParams:a}=g,e=new Map(n.categoryLabels.map((o,u)=>[o,u]));let c={id:"",index:0,label:"",description:"",categoryIndex:0,categoryLabel:"",color:"",visible:!0,data:{},value:0,level:0,seq:0,children:[]};try{const o=function(){if(J(l)===!0)return JSON.parse(JSON.stringify(l));if(Array.isArray(l)===!1)return{id:""};let i;const s=new Map;l.forEach(r=>{if(!r.parent)i=r;else{const p=s.get(r.parent)??[];p.push(r),s.set(r.parent,p)}});const d=r=>({id:r.id,label:r.label,data:r.data,value:r.value,categoryLabel:r.categoryLabel,children:(s.get(r.id)??[]).map(p=>d(p))});return i?d(i):{id:""}}();let u=0;const t=(i,s,d)=>{const r=s+1,p=i.categoryLabel??null;let D=0;p!=null&&(e.has(p)||e.set(p,e.size),D=e.get(p)??0);const O=u;u++;const h={id:i.id,index:O,level:s,seq:d,label:i.label??"",description:i.description??"",categoryIndex:D,categoryLabel:p,color:U(D,a),data:i.data??{},value:i.value,visible:!0,children:(i.children??[]).map((f,M)=>t(f,r,M))};return h.visible=n.visibleFilter(h,g),h};c=t(o,0,0)}catch(o){throw Error(o)}return c},it=({computedData$:g})=>g.pipe(A(l=>{function n(a,e){return a.push(e),e.children&&e.children.forEach(c=>{a=n(a,c)}),a}return n([],l)})),st=({nodeList$:g,fullDataFormatter$:l})=>{const n=l.pipe(A(a=>a.categoryLabels),F((a,e)=>JSON.stringify(a).length===JSON.stringify(e).length));return H({nodeList:g,categoryLabels:n}).pipe(k(async a=>a),A(a=>{const e=new Set(a.categoryLabels),c=new Set(a.nodeList.filter(o=>o.visible).map(o=>o.categoryLabel));return Array.from(c).forEach(o=>{e.has(o)||e.add(o)}),Array.from(e).forEach(o=>{c.has(o)||c.delete(o)}),Array.from(e)}),F((a,e)=>JSON.stringify(a).length===JSON.stringify(e).length))},nt=({computedData$:g})=>g.pipe(A(l=>{function n(a){return a.children&&(a.children=a.children.filter(e=>e.visible).map(e=>n(e))),a}return n(l)})),ot=({subject:g,observer:l})=>{const n=q(l.fullChartParams$).pipe($(1)),a=it({computedData$:l.computedData$}).pipe($(1)),e=W({datumList$:a,fullChartParams$:l.fullChartParams$,event$:g.event$}).pipe($(1)),c=st({nodeList$:a,fullDataFormatter$:l.fullDataFormatter$}).pipe($(1)),o=V({datumList$:a}).pipe($(1)),u=nt({computedData$:l.computedData$}).pipe($(1));return{fullParams$:l.fullParams$,fullChartParams$:l.fullChartParams$,fullDataFormatter$:l.fullDataFormatter$,computedData$:l.computedData$,layout$:l.layout$,textSizePx$:n,treeHighlight$:e,existCategoryLabels$:c,CategoryDataMap$:o,visibleComputedData$:u}};class yt extends G{constructor(l,n){super({defaultDataFormatter:X,computedDataFn:lt,contextObserverFn:ot},l,n)}}const w="TreeLegend",mt=_(w,Y)(({selection:g,rootSelection:l,observer:n,subject:a})=>{const e=new j,c=n.CategoryDataMap$.pipe(y(e),x(t=>Array.from(t.keys()))),o=n.fullParams$.pipe(y(e),x(t=>{const i=[{listRectWidth:t.listRectWidth,listRectHeight:t.listRectHeight,listRectRadius:t.listRectRadius}];return{...t,seriesList:i}})),u=Q(w,{rootSelection:l,seriesLabels$:c,fullParams$:o,layout$:n.layout$,fullChartParams$:n.fullChartParams$,textSizePx$:n.textSizePx$});return()=>{e.next(void 0),u()}}),m="TreeMap",I=B(m,"tree"),N=B(m,"tile");function ct({selection:g,treeData:l,fullParams:n,fullChartParams:a,textSizePx:e}){const c=e/2,o=e,u=g.selectAll(`g.${I}`).data(l,t=>t.data.id).join("g").attr("class",I);return u.attr("transform",t=>!t.x0||!t.y0?null:`translate(${t.x0},${t.y0})`).each((t,i,s)=>{const d=L(s[i]);d.selectAll(`rect.${N}`).data([t],r=>r.data.id).join("rect").attr("id",r=>r.data.id).attr("class",N).attr("cursor","pointer").attr("width",r=>r.x1-r.x0).attr("height",r=>r.y1-r.y0).attr("fill",r=>r.data.color).attr("data-name",r=>r.data.label).attr("data-category",r=>r.data.categoryLabel).attr("data-value",r=>r.data.value),d.selectAll("g").data([t]).join("g").each((r,p,D)=>{L(D[p]).selectAll("text").data([r]).join("text").text(h=>h.data.label).attr("dominant-baseline","hanging").attr("x",c).attr("y",c).attr("font-size",a.styles.textSize).each(function(h){const f=L(this),M=h.data.label.split(/\s+/).reverse();let P,C=[];const E=f.attr("x");let R=f.attr("y"),z=0,b=f.text(null).append("tspan").attr("cursor","pointer").attr("fill",v(n.labelColorType,a)).attr("font-size",a.styles.textSize).attr("x",E).attr("y",R);for(;P=M.pop();)C.push(P),b.text(C.join(" ")),b.node().getComputedTextLength()>h.x1-h.x0-c&&(C.pop(),b.text(C.join(" ")),C=[P],z+=o,b=f.append("tspan").attr("cursor","pointer").attr("fill",v(n.labelColorType,a)).attr("font-size",a.styles.textSize).attr("x",E).attr("y",R).attr("dy",z+"px").text(P))})})}),u}function gt({selection:g,ids:l,fullChartParams:n}){if(g.interrupt("highlight"),!l.length){g.transition("highlight").duration(200).style("opacity",1);return}g.each((a,e,c)=>{l.includes(a.data.id)?L(c[e]).style("opacity",1):L(c[e]).style("opacity",n.styles.unhighlightedOpacity)})}const ft=_(m,Z)(({selection:g,name:l,subject:n,observer:a})=>{const e=new j,c=T({layout:a.layout$,visibleComputedData:a.visibleComputedData$,fullParams:a.fullParams$,fullDataFormatter:a.fullDataFormatter$,fullChartParams:a.fullChartParams$}).pipe(y(e),S(async t=>t),x(t=>{const i=tt().size([t.layout.width,t.layout.height]).paddingInner(t.fullParams.paddingInner).paddingOuter(t.fullParams.paddingOuter).round(!0).tile(at.ratio(t.fullParams.squarifyRatio)),s=et(t.visibleComputedData).sum(r=>r.value).sort(t.fullParams.sort);return i(s),s.leaves()})),o=T({selection:rt(g),treeData:c,fullParams:a.fullParams$,fullChartParams:a.fullChartParams$,textSizePx:a.textSizePx$}).pipe(y(e),S(async t=>t),x(t=>ct({selection:g,treeData:t.treeData,fullParams:t.fullParams,fullChartParams:t.fullChartParams,textSizePx:t.textSizePx}))),u=a.fullChartParams$.pipe(y(e),x(t=>t.highlightTarget),K());return T({cellSelection:o,computedData:a.computedData$,treeData:c,fullParams:a.fullParams$,fullChartParams:a.fullChartParams$,highlightTarget:u,CategoryDataMap:a.CategoryDataMap$}).pipe(y(e),S(async t=>t)).subscribe(t=>{t.cellSelection.on("mouseover",(i,s)=>{i.stopPropagation(),n.event$.next({type:"tree",eventName:"mouseover",pluginName:m,highlightTarget:t.highlightTarget,datum:s.data,category:t.CategoryDataMap.get(s.data.categoryLabel),categoryIndex:s.data.categoryIndex,categoryLabel:s.data.categoryLabel,event:i,data:t.computedData})}).on("mousemove",(i,s)=>{i.stopPropagation(),n.event$.next({type:"tree",eventName:"mousemove",pluginName:m,highlightTarget:t.highlightTarget,datum:s.data,category:t.CategoryDataMap.get(s.data.categoryLabel),categoryIndex:s.data.categoryIndex,categoryLabel:s.data.categoryLabel,event:i,data:t.computedData})}).on("mouseout",(i,s)=>{i.stopPropagation(),n.event$.next({type:"tree",eventName:"mouseout",pluginName:m,highlightTarget:t.highlightTarget,datum:s.data,category:t.CategoryDataMap.get(s.data.categoryLabel),categoryIndex:s.data.categoryIndex,categoryLabel:s.data.categoryLabel,event:i,data:t.computedData})}).on("click",(i,s)=>{i.stopPropagation(),n.event$.next({type:"tree",eventName:"click",pluginName:m,highlightTarget:t.highlightTarget,datum:s.data,category:t.CategoryDataMap.get(s.data.categoryLabel),categoryIndex:s.data.categoryIndex,categoryLabel:s.data.categoryLabel,event:i,data:t.computedData})})}),T({cellSelection:o,highlight:a.treeHighlight$.pipe(x(t=>t.map(i=>i.id))),fullChartParams:a.fullChartParams$}).pipe(y(e),S(async t=>t)).subscribe(t=>{gt({selection:t.cellSelection,ids:t.highlight,fullChartParams:t.fullChartParams})}),()=>{e.next(void 0)}});export{mt as T,ft as a,yt as b};

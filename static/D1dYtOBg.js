import{w as N,S as W,d,e as R,t as P,f as C,s as L,g as B,L as k,M as z,N as A,P as E,O as U,Q as O,R as q,T as F,U as H}from"./C-r1ajy-.js";import{c as _}from"./C55koCnE.js";function V(a,{text:n,radius:s,lineHeight:o,isBreakAll:c=!1,limit:h=0}){if(a==null||n==null){console.error("selection or text is not defined");return}s==null&&(s=a.node().getBBox().width/2);function r(i){let e;return c?e=i.split(""):e=i.split(/\s+/g),e[e.length-1]||e.pop(),e[0]||e.shift(),e}function u(i,e){return i&&e&&i.length>e&&(i=i.substring(0,e)+"..."),i}function g(i){var l;const e=document.createElement("canvas").getContext("2d");return((l=e==null?void 0:e.measureText(i))==null?void 0:l.width)??0}function b(i){const e=g(i.trim());return Math.sqrt(e*o)}function y(i,e){let l={width:0,text:""},p=1/0;const f=[];let x=" ";c&&(x="");for(let m=0,D=i.length;m<D;++m){const T=(l.text?l.text+x:"")+i[m],$=g(T);(p+$)/2<e?(l.width=p=$,l.text=T):(p=g(i[m]),l={width:p,text:i[m]},f.push(l))}return f}function M(i){let e=0;for(let l=0,p=i.length;l<p;++l){const f=(Math.abs(l-p/2+.5)+.5)*o,x=i[l].width/2;e=Math.max(e,Math.sqrt(x**2+f**2))}return e}function t(i,e){h>0&&(e=u(e,h));const l=r(e),p=b(e),f=y(l,p),x=M(f);let m=i.select("text");m.size()||(m=i.append("text")),m.attr("transform",`translate(0,0) scale(${s/x})`);const D=m.selectAll("tspan").data(f),T=D.enter().append("tspan").attr("x",0).merge(D).attr("y",($,I)=>(I-f.length/2+.8)*o).text($=>$.text);return D.exit().remove(),D.merge(T)}return t(a,n)}let S;function G(a,n){return q().velocityDecay(n.force.velocityDecay).force("collision",F().radius(s=>s.r+n.force.collisionSpacing)).force("charge",H().strength(s=>-Math.pow(s.r,2)*n.force.strength)).on("tick",()=>{a.attr("transform",s=>`translate(${s.x},${s.y})`)})}function Q({data:a,bubbleGroupR:n,maxValue:s,avgValue:o}){const c=n/Math.sqrt(a.length),r=c*c*Math.PI/o,u=s*r;return Math.pow(u/Math.PI,.5)*.75}function X({data:a,LastBubbleDataMap:n,graphicWidth:s,graphicHeight:o,SeriesContainerPositionMap:c,scaleType:h}){const r=Math.min(s,o)/2,u=a.flat().filter(e=>e.value!=null&&e.visible!=!1),g=Math.max(...u.map(e=>e.value)),b=u.reduce((e,l)=>e+(l.value??0),0)/u.length,y=Q({data:u,bubbleGroupR:r,maxValue:g,avgValue:b}),M=h==="area"?.5:1,t=O().domain([0,g]).range([0,y]).exponent(M);return u.map(e=>{const l=e,p=n.get(e.id);if(p)l.x=p.x,l.y=p.y;else{const x=c.get(l.seriesLabel);l.x=Math.random()*x.width,l.y=Math.random()*x.height}const f=t(l.value??0);return l.r=f,l._originR=f,l})}function w({graphicSelection:a,bubblesData:n,fullParams:s,sumSeries:o}){const c=a.selectAll("g").data(n,r=>r.id).join(r=>{const u=r.append("g").attr("cursor","pointer").attr("font-size",12).style("fill","#ffffff").attr("text-anchor","middle");return u.append("circle").attr("class","node").attr("cx",0).attr("cy",0).attr("fill",g=>g.color),u.append("text").style("opacity",.8).attr("pointer-events","none"),u},r=>r,r=>r.remove()).attr("transform",r=>`translate(${r.x},${r.y})`),h=o?"seriesLabel":"label";return c.select("circle").transition().duration(200).attr("r",r=>r.r).attr("fill",r=>r.color),c.each((r,u,g)=>{const b=B(g[u]);let y=!0;r[h].length<=s.bubbleText.lineLengthMin&&(y=!1),b.call(V,{text:r[h],radius:r.r*s.bubbleText.fillRate,lineHeight:s.bubbleText.lineHeight,isBreakAll:y})}),c}function Y({data:a,highlightRIncrease:n,highlightIds:s}){if(n!=0){if(!s.length){a.forEach(o=>o.r=o._originR);return}a.forEach(o=>{s.includes(o.id)?o.r=o._originR+n:o.r=o._originR})}}function J(){return k().on("start",(a,n)=>{a.active||S.alpha(1).restart(),n.fx=n.x,n.fy=n.y}).on("drag",(a,n)=>{a.active||S.alphaTarget(0),n.fx=a.x,n.fy=a.y}).on("end",(a,n)=>{n.fx=null,n.fy=null})}function v({fullParams:a,SeriesContainerPositionMap:n}){S.force("x",z().strength(a.force.strength).x(s=>n.get(s.seriesLabel).centerX)).force("y",A().strength(a.force.strength).y(s=>n.get(s.seriesLabel).centerY)),S.alpha(1).restart()}function K({bubblesSelection:a,highlightIds:n,fullChartParams:s}){if(a.interrupt("highlight"),!n.length){a.transition("highlight").style("opacity",1);return}a.each((o,c,h)=>{const r=B(h[c]);n.includes(o.id)?r.style("opacity",1).transition("highlight").ease(E).duration(500):r.style("opacity",s.styles.unhighlightedOpacity)})}const ee=N("Bubbles",_)(({selection:a,name:n,observer:s,subject:o})=>{const c=new W,h=a.append("g");let r=new Map;const u=s.fullDataFormatter$.pipe(d(t=>t.sumSeries),R()),g=s.fullParams$.pipe(P(c),d(t=>t.bubbleScaleType),R()),b=new U(t=>{C({layout:s.layout$,SeriesContainerPositionMap:s.SeriesContainerPositionMap$,visibleComputedLayoutData:s.visibleComputedLayoutData$,scaleType:g}).pipe(P(c),L(async i=>i)).subscribe(i=>{const e=X({data:i.visibleComputedLayoutData,LastBubbleDataMap:r,graphicWidth:i.layout.width,graphicHeight:i.layout.height,SeriesContainerPositionMap:i.SeriesContainerPositionMap,scaleType:i.scaleType});t.next(e)})});b.subscribe(t=>{r=new Map(t.map(i=>[i.id,i]))});const y=s.fullChartParams$.pipe(P(c),d(t=>t.highlightTarget),R()),M=C({bubblesData:b,fullParams:s.fullParams$,SeriesContainerPositionMap:s.SeriesContainerPositionMap$,sumSeries:u}).pipe(P(c),L(async t=>t),d(t=>{const i=w({graphicSelection:h,bubblesData:t.bubblesData,fullParams:t.fullParams,sumSeries:t.sumSeries});return S=G(i,t.fullParams),S.nodes(t.bubblesData),v({fullParams:t.fullParams,SeriesContainerPositionMap:t.SeriesContainerPositionMap}),i}));return C({bubblesSelection:M,layout:s.layout$,computedData:s.computedData$,bubblesData:b,SeriesDataMap:s.SeriesDataMap$,fullParams:s.fullParams$,highlightTarget:y,SeriesContainerPositionMap:s.SeriesContainerPositionMap$}).pipe(P(c),L(async t=>t)).subscribe(t=>{t.bubblesSelection.on("mouseover",(i,e)=>{o.event$.next({type:"series",eventName:"mouseover",pluginName:n,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:i,data:t.computedData})}).on("mousemove",(i,e)=>{o.event$.next({type:"series",eventName:"mousemove",pluginName:n,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:i,data:t.computedData})}).on("mouseout",(i,e)=>{o.event$.next({type:"series",eventName:"mouseout",pluginName:n,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:i,data:t.computedData})}).on("click",(i,e)=>{o.event$.next({type:"series",eventName:"click",pluginName:n,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:i,data:t.computedData})}).call(J())}),C({bubblesSelection:M,bubblesData:b,highlight:s.seriesHighlight$.pipe(d(t=>t.map(i=>i.id))),fullChartParams:s.fullChartParams$,fullParams:s.fullParams$,sumSeries:u,SeriesContainerPositionMap:s.SeriesContainerPositionMap$}).pipe(P(c),L(async t=>t)).subscribe(t=>{K({bubblesSelection:t.bubblesSelection,highlightIds:t.highlight,fullChartParams:t.fullChartParams}),t.fullParams.highlightRIncrease&&(Y({data:t.bubblesData,highlightRIncrease:t.fullParams.highlightRIncrease,highlightIds:t.highlight}),w({graphicSelection:h,bubblesData:t.bubblesData,fullParams:t.fullParams,sumSeries:t.sumSeries})),v({fullParams:t.fullParams,SeriesContainerPositionMap:t.SeriesContainerPositionMap}),S.nodes(t.bubblesData)}),()=>{c.next(void 0)}});export{ee as B};

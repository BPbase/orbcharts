import{ar as v,by as k,av as U,bz as q,aC as R,aF as J,aJ as V,az as b,aL as W,bA as X,aM as Y,bB as G,bC as E,a as F,t as T,m as C,ae as K,aO as Q,k as L,l as O,d as Z,af as tt,L as et,s as P,bD as at,bE as rt,bF as lt,u as N,g as w,ag as ot,aq as nt}from"./DthhAFdh.js";import{c as it}from"./DutSHzz9.js";import{o as st}from"./BEDn8b6V.js";import{c as ct}from"./Dk-w_uFh.js";const ut=o=>v(o,{visibleFilter:{toBeTypes:["Function"]},categoryLabels:{toBeTypes:["string[]"]}}),pt=o=>{const{data:a=[],dataFormatter:r,chartParams:e}=o,n=q(),s=new Map(r.categoryLabels.map((u,t)=>[u,t]));let g={id:"",index:0,label:"",description:"",categoryIndex:-1,categoryLabel:"",color:"",visible:!0,data:{},value:0,level:0,seq:0,children:[]};try{const u=function(){if(k(a)===!0)return JSON.parse(JSON.stringify(a));if(Array.isArray(a)===!1)return{id:""};let l;const y=new Map;a.forEach(p=>{if(!p.parent)l=p;else{const d=y.get(p.parent)??[];d.push(p),y.set(p.parent,d)}});const i=p=>({id:p.id,label:p.label,data:p.data,value:p.value,categoryLabel:p.categoryLabel??n,children:(y.get(p.id)??[]).map(d=>i(d))});return l?i(l):{id:""}}();let t=0;const c=(l,y,i)=>{const p=y+1,d=l.categoryLabel??n;s.has(d)||s.set(d,s.size);const B=s.get(d)??0,m=t;t++;const h={id:l.id,index:m,level:y,seq:i,label:l.label??"",description:l.description??"",categoryIndex:B,categoryLabel:d,color:U(B,e),data:l.data??{},value:l.value,visible:!0,children:(l.children??[]).map((A,$)=>c(A,p,$))};return h.visible=r.visibleFilter(h,o),h};g=c(u,0,0)}catch(u){throw Error(u)}return g},gt=o=>v({data:o},{data:{toBe:"DataTreeObj | DataTreeDatum[]",test:r=>k(r)&&r.id!==void 0||Array.isArray(r)}}),dt=({computedData$:o})=>o.pipe(R(a=>{function r(e,n){return e.push(n),n.children&&n.children.forEach(s=>{e=r(e,s)}),e}return r([],a)})),yt=o=>o.pipe(R(a=>Array.from(a.keys())),J((a,r)=>JSON.stringify(a).length===JSON.stringify(r).length)),mt=({computedData$:o})=>o.pipe(R(a=>{function r(e){return e.children&&(e.children=e.children.filter(n=>n.visible).map(n=>r(n))),e}return r(a)})),ht=({subject:o,observer:a})=>{const r=V(a.fullChartParams$).pipe(b(1)),e=dt({computedData$:a.computedData$}).pipe(b(1)),n=W({datumList$:e,fullChartParams$:a.fullChartParams$,event$:o.event$}).pipe(b(1)),s=X({datumList$:e}).pipe(b(1)),g=yt(s).pipe(b(1)),u=mt({computedData$:a.computedData$}).pipe(b(1));return{fullParams$:a.fullParams$,fullChartParams$:a.fullChartParams$,fullDataFormatter$:a.fullDataFormatter$,computedData$:a.computedData$,layout$:a.layout$,textSizePx$:r,treeHighlight$:n,categoryLabels$:g,CategoryDataMap$:s,visibleComputedData$:u}};class Ot extends Y{constructor(a,r){super({defaultDataFormatter:G,dataFormatterValidator:ut,computedDataFn:pt,dataValidator:gt,contextObserverCallback:ht},a,r)}}const j="TreeLegend",ft={name:j,defaultParams:K,layerIndex:Q,validator:(o,{validateColumns:a})=>a(o,{placement:{toBe:'"top" | "top-start" | "top-end" | "bottom" | "bottom-start" | "bottom-end" | "left" | "left-start" | "left-end" | "right" | "right-start" | "right-end"',test:e=>["top","top-start","top-end","bottom","bottom-start","bottom-end","left","left-start","left-end","right","right-start","right-end"].includes(e)},padding:{toBeTypes:["number"]},backgroundFill:{toBeOption:"ColorType"},backgroundStroke:{toBeOption:"ColorType"},gap:{toBeTypes:["number"]},listRectWidth:{toBeTypes:["number"]},listRectHeight:{toBeTypes:["number"]},listRectRadius:{toBeTypes:["number"]},textColorType:{toBeOption:"ColorType"}})},Bt=E(ft)(({selection:o,rootSelection:a,observer:r,subject:e})=>{const n=new F,s=r.fullParams$.pipe(T(n),C(u=>{const t=[{listRectWidth:u.listRectWidth,listRectHeight:u.listRectHeight,listRectRadius:u.listRectRadius}];return{...u,labelList:t}})),g=it(j,{rootSelection:a,legendLabels$:r.categoryLabels$,fullParams$:s,layout$:r.layout$,fullChartParams$:r.fullChartParams$,textSizePx$:r.textSizePx$});return()=>{n.next(void 0),g()}}),f="TreeMap",_=w(f,"tree"),z=w(f,"tile"),$t={name:f,defaultParams:tt,layerIndex:et,validator:(o,{validateColumns:a})=>a(o,{paddingInner:{toBeTypes:["number"]},paddingOuter:{toBeTypes:["number"]},labelColorType:{toBeOption:"ColorType"},squarifyRatio:{toBeTypes:["number"]},sort:{toBeTypes:["Function"]}})};function bt({selection:o,treeData:a,fullParams:r,fullChartParams:e,textSizePx:n}){const s=n/2,g=n,u=o.selectAll(`g.${_}`).data(a,t=>t.data.id).join("g").attr("class",_);return u.attr("transform",t=>!t.x0||!t.y0?null:`translate(${t.x0},${t.y0})`).each((t,c,l)=>{const y=P(l[c]);y.selectAll(`rect.${z}`).data([t],i=>i.data.id).join("rect").attr("id",i=>i.data.id).attr("class",z).attr("cursor","pointer").attr("width",i=>i.x1-i.x0).attr("height",i=>i.y1-i.y0).attr("fill",i=>i.data.color).attr("data-name",i=>i.data.label).attr("data-category",i=>i.data.categoryLabel).attr("data-value",i=>i.data.value),y.selectAll("g").data([t]).join("g").each((i,p,d)=>{P(d[p]).selectAll("text").data([i]).join("text").text(m=>m.data.label).attr("dominant-baseline","hanging").attr("x",s).attr("y",s).attr("font-size",e.styles.textSize).each(function(m){const h=P(this),A=m.data.label.split(/\s+/).reverse();let $,x=[];const I=h.attr("x");let S=h.attr("y"),M=0,D=h.text(null).append("tspan").attr("cursor","pointer").attr("fill",N({colorType:r.labelColorType,datum:m.data,fullChartParams:e})).attr("font-size",e.styles.textSize).attr("x",I).attr("y",S);for(;$=A.pop();)x.push($),D.text(x.join(" ")),D.node().getComputedTextLength()>m.x1-m.x0-s&&(x.pop(),D.text(x.join(" ")),x=[$],M+=g,D=h.append("tspan").attr("cursor","pointer").attr("fill",N({colorType:r.labelColorType,datum:m.data,fullChartParams:e})).attr("font-size",e.styles.textSize).attr("x",I).attr("y",S).attr("dy",M+"px").text($))})})}),u}function Tt({selection:o,ids:a,fullChartParams:r}){if(o.interrupt("highlight"),!a.length){o.transition("highlight").duration(200).style("opacity",1);return}o.each((e,n,s)=>{a.includes(e.data.id)?P(s[n]).style("opacity",1):P(s[n]).style("opacity",r.styles.unhighlightedOpacity)})}const At=E($t)(({selection:o,name:a,subject:r,observer:e})=>{const n=new F,s=L({layout:e.layout$,visibleComputedData:e.visibleComputedData$,fullParams:e.fullParams$,fullDataFormatter:e.fullDataFormatter$,fullChartParams:e.fullChartParams$}).pipe(T(n),O(async t=>t),C(t=>{const c=at().size([t.layout.width,t.layout.height]).paddingInner(t.fullParams.paddingInner).paddingOuter(t.fullParams.paddingOuter).round(!0).tile(rt.ratio(t.fullParams.squarifyRatio)),l=lt(t.visibleComputedData).sum(i=>i.value).sort(t.fullParams.sort);return c(l),l.leaves()})),g=L({selection:st(o),treeData:s,fullParams:e.fullParams$,fullChartParams:e.fullChartParams$,textSizePx:e.textSizePx$}).pipe(T(n),O(async t=>t),C(t=>bt({selection:o,treeData:t.treeData,fullParams:t.fullParams,fullChartParams:t.fullChartParams,textSizePx:t.textSizePx}))),u=e.fullChartParams$.pipe(T(n),C(t=>t.highlightTarget),Z());return L({cellSelection:g,computedData:e.computedData$,treeData:s,fullParams:e.fullParams$,fullChartParams:e.fullChartParams$,highlightTarget:u,CategoryDataMap:e.CategoryDataMap$}).pipe(T(n),O(async t=>t)).subscribe(t=>{t.cellSelection.on("mouseover",(c,l)=>{c.stopPropagation(),r.event$.next({type:"tree",eventName:"mouseover",pluginName:f,highlightTarget:t.highlightTarget,datum:l.data,category:t.CategoryDataMap.get(l.data.categoryLabel),categoryIndex:l.data.categoryIndex,categoryLabel:l.data.categoryLabel,event:c,data:t.computedData})}).on("mousemove",(c,l)=>{c.stopPropagation(),r.event$.next({type:"tree",eventName:"mousemove",pluginName:f,highlightTarget:t.highlightTarget,datum:l.data,category:t.CategoryDataMap.get(l.data.categoryLabel),categoryIndex:l.data.categoryIndex,categoryLabel:l.data.categoryLabel,event:c,data:t.computedData})}).on("mouseout",(c,l)=>{c.stopPropagation(),r.event$.next({type:"tree",eventName:"mouseout",pluginName:f,highlightTarget:t.highlightTarget,datum:l.data,category:t.CategoryDataMap.get(l.data.categoryLabel),categoryIndex:l.data.categoryIndex,categoryLabel:l.data.categoryLabel,event:c,data:t.computedData})}).on("click",(c,l)=>{c.stopPropagation(),r.event$.next({type:"tree",eventName:"click",pluginName:f,highlightTarget:t.highlightTarget,datum:l.data,category:t.CategoryDataMap.get(l.data.categoryLabel),categoryIndex:l.data.categoryIndex,categoryLabel:l.data.categoryLabel,event:c,data:t.computedData})})}),L({cellSelection:g,highlight:e.treeHighlight$.pipe(C(t=>t.map(c=>c.id))),fullChartParams:e.fullChartParams$}).pipe(T(n),O(async t=>t)).subscribe(t=>{Tt({selection:t.cellSelection,ids:t.highlight,fullChartParams:t.fullChartParams})}),()=>{n.next(void 0)}}),H="TreeTooltip",xt={name:H,defaultParams:ot,layerIndex:nt,validator:(o,{validateColumns:a})=>a(o,{backgroundColorType:{toBeOption:"ColorType"},backgroundOpacity:{toBeTypes:["number"]},strokeColorType:{toBeOption:"ColorType"},offset:{toBe:"[number, number]",test:e=>Array.isArray(e)&&e.length===2&&typeof e[0]=="number"&&typeof e[1]=="number"},padding:{toBeTypes:["number"]},textColorType:{toBeOption:"ColorType"},renderFn:{toBeTypes:["Function"]}})},Rt=E(xt)(({selection:o,rootSelection:a,name:r,subject:e,observer:n})=>{const s=new F,g=ct(H,{rootSelection:a,fullParams$:n.fullParams$,fullChartParams$:n.fullChartParams$,layout$:n.layout$,event$:e.event$});return()=>{s.next(void 0),g()}});export{Bt as T,At as a,Rt as b,Ot as c};

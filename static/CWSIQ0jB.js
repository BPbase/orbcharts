import{q as N,S as W,d,e as R,t as $,f as C,s as L,g as B,a1 as k,a2 as z,a3 as A,Z as E,O as U,$ as q,a4 as O,a5 as F,a6 as H}from"./_HanNZE-.js";import{e as _}from"./UFs7gonu.js";function V(n,{text:a,radius:s,lineHeight:o,isBreakAll:c=!1,limit:h=0}){if(n==null||a==null){console.error("selection or text is not defined");return}s==null&&(s=n.node().getBBox().width/2);function r(i){let e;return c?e=i.split(""):e=i.split(/\s+/g),e[e.length-1]||e.pop(),e[0]||e.shift(),e}function u(i,e){return i&&e&&i.length>e&&(i=i.substring(0,e)+"..."),i}function g(i){var l;const e=document.createElement("canvas").getContext("2d");return((l=e==null?void 0:e.measureText(i))==null?void 0:l.width)??0}function f(i){const e=g(i.trim());return Math.sqrt(e*o)}function y(i,e){let l={width:0,text:""},p=1/0;const b=[];let x=" ";c&&(x="");for(let m=0,M=i.length;m<M;++m){const T=(l.text?l.text+x:"")+i[m],P=g(T);(p+P)/2<e?(l.width=p=P,l.text=T):(p=g(i[m]),l={width:p,text:i[m]},b.push(l))}return b}function D(i){let e=0;for(let l=0,p=i.length;l<p;++l){const b=(Math.abs(l-p/2+.5)+.5)*o,x=i[l].width/2;e=Math.max(e,Math.sqrt(x**2+b**2))}return e}function t(i,e){h>0&&(e=u(e,h));const l=r(e),p=f(e),b=y(l,p),x=D(b);let m=i.select("text");m.size()||(m=i.append("text")),m.attr("transform",`translate(0,0) scale(${s/x})`);const M=m.selectAll("tspan").data(b),T=M.enter().append("tspan").attr("x",0).merge(M).attr("y",(P,I)=>(I-b.length/2+.8)*o).text(P=>P.text);return M.exit().remove(),M.merge(T)}return t(n,a)}let S;function G(n,a){return O().velocityDecay(a.force.velocityDecay).force("collision",F().radius(s=>s.r+a.force.collisionSpacing)).force("charge",H().strength(s=>-Math.pow(s.r,2)*a.force.strength)).on("tick",()=>{n.attr("transform",s=>`translate(${s.x},${s.y})`)})}function X({data:n,bubbleGroupR:a,maxValue:s,avgValue:o}){const c=a/Math.sqrt(n.length),r=c*c*Math.PI/o,u=s*r;return Math.pow(u/Math.PI,.5)*.785}function Y({data:n,LastBubbleDataMap:a,graphicWidth:s,graphicHeight:o,SeriesContainerPositionMap:c,scaleType:h}){const r=Math.min(s,o)/2,u=n.flat().filter(e=>e.value!=null&&e.visible!=!1),g=Math.max(...u.map(e=>e.value)),f=u.reduce((e,l)=>e+(l.value??0),0)/u.length,y=X({data:u,bubbleGroupR:r,maxValue:g,avgValue:f}),D=h==="area"?.5:1,t=q().domain([0,g]).range([0,y]).exponent(D);return u.map(e=>{const l=e,p=a.get(e.id);if(p)l.x=p.x,l.y=p.y;else{const x=c.get(l.seriesLabel);l.x=Math.random()*x.width,l.y=Math.random()*x.height}const b=t(l.value??0);return l.r=b,l._originR=b,l})}function v({graphicSelection:n,bubblesData:a,fullParams:s,sumSeries:o}){const c=n.selectAll("g").data(a,r=>r.id).join(r=>{const u=r.append("g").attr("cursor","pointer").attr("font-size",12).style("fill","#ffffff").attr("text-anchor","middle");return u.append("circle").attr("class","node").attr("cx",0).attr("cy",0).attr("fill",g=>g.color),u.append("text").style("opacity",.8).attr("pointer-events","none"),u},r=>r,r=>r.remove()).attr("transform",r=>`translate(${r.x},${r.y})`),h=o?"seriesLabel":"label";return c.select("circle").transition().duration(200).attr("r",r=>r.r).attr("fill",r=>r.color),c.each((r,u,g)=>{const f=B(g[u]);let y=!0;r[h].length<=s.bubbleText.lineLengthMin&&(y=!1),f.call(V,{text:r[h],radius:r.r*s.bubbleText.fillRate,lineHeight:s.bubbleText.lineHeight,isBreakAll:y})}),c}function Z({data:n,highlightRIncrease:a,highlightIds:s}){if(a!=0){if(!s.length){n.forEach(o=>o.r=o._originR);return}n.forEach(o=>{s.includes(o.id)?o.r=o._originR+a:o.r=o._originR})}}function J(){return k().on("start",(n,a)=>{n.active||S.alpha(1).restart(),a.fx=a.x,a.fy=a.y}).on("drag",(n,a)=>{n.active||S.alphaTarget(0),a.fx=n.x,a.fy=n.y}).on("end",(n,a)=>{a.fx=null,a.fy=null})}function w({fullParams:n,SeriesContainerPositionMap:a}){S.force("x",z().strength(n.force.strength).x(s=>a.get(s.seriesLabel).centerX)).force("y",A().strength(n.force.strength).y(s=>a.get(s.seriesLabel).centerY)),S.alpha(1).restart()}function K({bubblesSelection:n,highlightIds:a,fullChartParams:s}){if(n.interrupt("highlight"),!a.length){n.transition("highlight").style("opacity",1);return}n.each((o,c,h)=>{const r=B(h[c]);a.includes(o.id)?r.style("opacity",1).transition("highlight").ease(E).duration(500):r.style("opacity",s.styles.unhighlightedOpacity)})}const ee=N("Bubbles",_)(({selection:n,name:a,observer:s,subject:o})=>{const c=new W,h=n.append("g");let r=new Map;const u=s.fullDataFormatter$.pipe(d(t=>t.sumSeries),R()),g=s.fullParams$.pipe($(c),d(t=>t.arcScaleType),R()),f=new U(t=>{C({layout:s.layout$,SeriesContainerPositionMap:s.SeriesContainerPositionMap$,visibleComputedLayoutData:s.visibleComputedLayoutData$,scaleType:g}).pipe($(c),L(async i=>i)).subscribe(i=>{const e=Y({data:i.visibleComputedLayoutData,LastBubbleDataMap:r,graphicWidth:i.layout.width,graphicHeight:i.layout.height,SeriesContainerPositionMap:i.SeriesContainerPositionMap,scaleType:i.scaleType});t.next(e)})});f.subscribe(t=>{r=new Map(t.map(i=>[i.id,i]))});const y=s.fullChartParams$.pipe($(c),d(t=>t.highlightTarget),R()),D=C({bubblesData:f,fullParams:s.fullParams$,SeriesContainerPositionMap:s.SeriesContainerPositionMap$,sumSeries:u}).pipe($(c),L(async t=>t),d(t=>{const i=v({graphicSelection:h,bubblesData:t.bubblesData,fullParams:t.fullParams,sumSeries:t.sumSeries});return S=G(i,t.fullParams),S.nodes(t.bubblesData),w({fullParams:t.fullParams,SeriesContainerPositionMap:t.SeriesContainerPositionMap}),i}));return C({bubblesSelection:D,layout:s.layout$,computedData:s.computedData$,bubblesData:f,SeriesDataMap:s.SeriesDataMap$,fullParams:s.fullParams$,highlightTarget:y,SeriesContainerPositionMap:s.SeriesContainerPositionMap$}).pipe($(c),L(async t=>t)).subscribe(t=>{t.bubblesSelection.on("mouseover",(i,e)=>{o.event$.next({type:"series",eventName:"mouseover",pluginName:a,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:i,data:t.computedData})}).on("mousemove",(i,e)=>{o.event$.next({type:"series",eventName:"mousemove",pluginName:a,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:i,data:t.computedData})}).on("mouseout",(i,e)=>{o.event$.next({type:"series",eventName:"mouseout",pluginName:a,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:i,data:t.computedData})}).on("click",(i,e)=>{o.event$.next({type:"series",eventName:"click",pluginName:a,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:i,data:t.computedData})}).call(J())}),C({bubblesSelection:D,bubblesData:f,highlight:s.seriesHighlight$.pipe(d(t=>t.map(i=>i.id))),fullChartParams:s.fullChartParams$,fullParams:s.fullParams$,sumSeries:u,SeriesContainerPositionMap:s.SeriesContainerPositionMap$}).pipe($(c),L(async t=>t)).subscribe(t=>{K({bubblesSelection:t.bubblesSelection,highlightIds:t.highlight,fullChartParams:t.fullChartParams}),t.fullParams.highlightRIncrease&&(Z({data:t.bubblesData,highlightRIncrease:t.fullParams.highlightRIncrease,highlightIds:t.highlight}),v({graphicSelection:h,bubblesData:t.bubblesData,fullParams:t.fullParams,sumSeries:t.sumSeries})),w({fullParams:t.fullParams,SeriesContainerPositionMap:t.SeriesContainerPositionMap}),S.nodes(t.bubblesData)}),()=>{c.next(void 0)}});export{ee as B};

import{w as z,x as u,k as x,y as D,z as f,O as C,B as y,C as A,J as se}from"./BOl0c7Gx.js";import{n as oe}from"./CAxiItTp.js";import{g as ne,k as pe,b as v}from"./CXENxt6o.js";const O="BarStack",E=v(O,"g"),H=v(O,"g-content"),Z=.3;function ce({axisWidth:i,groupAmount:l,barGroupPadding:n=0}){const m=i/(l-1)-n;return m>1?m:1}function le(i,l){return i<=1?0:l/(i-1)*Z}function ge(i,l){return i<=1?l:l*(1-Z)}function ue({selection:i,data:l,zeroY:n,groupLabels:s,params:m,chartParams:c,barWidth:L,transformedBarRadius:I,delayGroup:S,transitionItem:w}){const M=L/2;return i.selectAll(`g.${E}`).data(l,(g,o)=>s[o]).join(g=>g.append("g").classed(E,!0).attr("cursor","pointer"),g=>g,g=>g.remove()).attr("transform",(g,o)=>`translate(${g[0]?g[0].axisX:0}, 0)`).each((g,o,G)=>{A(G[o]).selectAll("g").data(g,h=>h.id).join(h=>h.append("g").classed(H,!0),h=>h,h=>h.remove()).each((h,F,P)=>{A(P[F]).selectAll("rect").data([h],p=>p.id).join(p=>p.append("rect").attr("y",$=>n).attr("height",$=>0),p=>p,p=>p.remove()).attr("rx",I[0]).attr("ry",I[1]).attr("fill",p=>p.color).attr("transform",`translate(${-M}, 0)`).attr("x",p=>0).attr("width",L).transition().duration(w).ease(pe(c.transitionEase)).delay((p,$)=>p.groupIndex*S).attr("y",p=>p._barStartY).attr("height",p=>Math.abs(p._barHeight))})}).selectAll(`g.${H}`)}function he({defsSelection:i,clipPathData:l}){i.selectAll("clipPath").data(l).join(n=>n.append("clipPath"),n=>n,n=>n.remove()).attr("id",n=>n.id).each((n,s,m)=>{A(m[s]).selectAll("rect").data([n]).join(c=>c.append("rect"),c=>c,c=>c.remove()).attr("x",0).attr("y",0).attr("width",c=>c.width).attr("height",c=>c.height)})}function be({selection:i,ids:l,fullChartParams:n}){if(i.interrupt("highlight"),!l.length){i.transition("highlight").duration(200).style("opacity",1);return}i.each((s,m,c)=>{l.includes(s.id)?A(c[m]).style("opacity",1):A(c[m]).style("opacity",n.styles.unhighlightedOpacity)})}const me=(i,{selection:l,computedData$:n,visibleComputedData$:s,SeriesDataMap$:m,GroupDataMap$:c,fullParams$:L,fullDataFormatter$:I,fullChartParams$:S,gridAxesTransform$:w,gridGraphicTransform$:M,gridAxesSize$:B,gridHighlight$:Y,event$:g})=>{const o=new z,G=ne(i,"clipPath-box"),h=l.append("g").attr("clip-path",`url(#${G})`),F=h.append("defs"),P=h.append("g"),p=new z;w.pipe(u(o),x(e=>e.value),D()).subscribe(e=>{h.style("transform",e)}),M.pipe(u(o),f(async e=>e.value),D()).subscribe(e=>{P.transition().duration(50).style("transform",e)});const $=s.pipe(x(e=>e[0]&&e[0][0]?e[0][0].axisY-e[0][0].axisYFromZero:0),D()),N=new C(e=>{y({computedData:n,params:L,axisSize:B}).pipe(f(async t=>t)).subscribe(t=>{const a=t.params.barWidth?t.params.barWidth:ce({axisWidth:t.axisSize.width,groupAmount:t.computedData[0]?t.computedData[0].length:0,barGroupPadding:t.params.barGroupPadding});e.next(a)})}).pipe(u(o),D()),J=y({gridGraphicTransform:M,barWidth:N,params:L}).pipe(u(o),f(async e=>e),x(e=>{const t=e.barWidth/2,a=e.params.barRadius===!0?t:e.params.barRadius===!1?0:typeof e.params.barRadius=="number"?e.params.barRadius:0,r=a==0?0:a/e.gridGraphicTransform.scale[0],d=a==0?0:a/e.gridGraphicTransform.scale[1];return[r,d]})),R=s.pipe(u(o),x(e=>{const t=new Set;return e.forEach(a=>{a.forEach(r=>{t.add(r.groupLabel)})}),Array.from(t)})),j=S.pipe(u(o),x(e=>e.transitionDuration),D()),K=new C(e=>{y({groupLabels:R,transitionDuration:j}).pipe(f(async t=>t)).subscribe(t=>{const a=le(t.groupLabels.length,t.transitionDuration);e.next(a)})}).pipe(u(o),D()),X=new C(e=>{y({groupLabels:R,transitionDuration:j}).pipe(f(async t=>t)).subscribe(t=>{const a=ge(t.groupLabels.length,t.transitionDuration);e.next(a)})}).pipe(u(o),D()),V=s.pipe(u(o),x(e=>{console.log("visibleComputedData",e);const t=e.length,a=e.reduce((d,b)=>Math.max(d,b.length),0),r=new Array(a).fill(null).map(()=>new Array(t).fill(null));for(let d=0;d<t;d++)for(let b=0;b<a;b++)r[b][d]=e[d][b];return r})),q=y({transposedVisibleData:V,dataFormatter:I}).pipe(u(o),f(async e=>e),x(e=>{const a=e.transposedVisibleData.length-1,r=e.dataFormatter.groupAxis.scaleDomain[0]==="auto"?0-e.dataFormatter.groupAxis.scalePadding:e.dataFormatter.groupAxis.scaleDomain[0]-e.dataFormatter.groupAxis.scalePadding,d=e.dataFormatter.groupAxis.scaleDomain[1]==="auto"?a+e.dataFormatter.groupAxis.scalePadding:e.dataFormatter.groupAxis.scaleDomain[1]+e.dataFormatter.groupAxis.scalePadding,b=e.transposedVisibleData.map(W=>W.filter((T,_)=>T.groupIndex>=r&&T.groupIndex<=d));if(b.flat().length){const W=b.flat().map(k=>k.axisYFromZero),T=Math.max(...W),_=b.map(k=>k.reduce((ae,ie)=>ae+ie.axisYFromZero,0)),te=Math.max(..._);return T/te}else return 1})),Q=y({transposedVisibleData:V,yRatio:q,zeroY:$}).pipe(u(o),x(e=>(console.log(e.transposedVisibleData),e.transposedVisibleData.map(t=>{let a=e.zeroY;return t.map(r=>{const d=a,b=r.axisYFromZero*e.yRatio;return a=a+b,{...r,_barStartY:d,_barHeight:b}})}))));B.pipe(u(o)).subscribe(e=>{const t=[{id:G,width:e.width,height:e.height}];he({defsSelection:F,clipPathData:t})});const ee=S.pipe(u(o),x(e=>e.highlightTarget),D());y({graphicData:Q,zeroY:$,groupLabels:R,params:L,chartParams:S,highlightTarget:ee,barWidth:N,transformedBarRadius:J,delayGroup:K,transitionItem:X,SeriesDataMap:m,GroupDataMap:c}).pipe(u(o),f(async e=>e)).subscribe(e=>{const t=ue({selection:P,data:e.graphicData,zeroY:e.zeroY,groupLabels:e.groupLabels,params:e.params,chartParams:e.chartParams,barWidth:e.barWidth,transformedBarRadius:e.transformedBarRadius,delayGroup:e.delayGroup,transitionItem:e.transitionItem});t.on("mouseover",(a,r)=>{a.stopPropagation(),g.next({type:"grid",eventName:"mouseover",pluginName:i,highlightTarget:e.highlightTarget,datum:r,series:e.SeriesDataMap.get(r.seriesLabel),seriesIndex:r.seriesIndex,seriesLabel:r.seriesLabel,groups:e.GroupDataMap.get(r.groupLabel),groupIndex:r.groupIndex,groupLabel:r.groupLabel,event:a,data:e.graphicData})}).on("mousemove",(a,r)=>{a.stopPropagation(),g.next({type:"grid",eventName:"mousemove",pluginName:i,highlightTarget:e.highlightTarget,datum:r,series:e.SeriesDataMap.get(r.seriesLabel),seriesIndex:r.seriesIndex,seriesLabel:r.seriesLabel,groups:e.GroupDataMap.get(r.groupLabel),groupIndex:r.groupIndex,groupLabel:r.groupLabel,event:a,data:e.graphicData})}).on("mouseout",(a,r)=>{a.stopPropagation(),g.next({type:"grid",eventName:"mouseout",pluginName:i,highlightTarget:e.highlightTarget,datum:r,series:e.SeriesDataMap.get(r.seriesLabel),seriesIndex:r.seriesIndex,seriesLabel:r.seriesLabel,groups:e.GroupDataMap.get(r.groupLabel),groupIndex:r.groupIndex,groupLabel:r.groupLabel,event:a,data:e.graphicData})}).on("click",(a,r)=>{a.stopPropagation(),g.next({type:"grid",eventName:"click",pluginName:i,highlightTarget:e.highlightTarget,datum:r,series:e.SeriesDataMap.get(r.seriesLabel),seriesIndex:r.seriesIndex,seriesLabel:r.seriesLabel,groups:e.GroupDataMap.get(r.groupLabel),groupIndex:r.groupIndex,groupLabel:r.groupLabel,event:a,data:e.graphicData})}),p.next(t)});const re=Y.subscribe();return y({barSelection:p,highlight:Y,fullChartParams:S}).pipe(u(o),f(async e=>e)).subscribe(e=>{be({selection:e.barSelection,ids:e.highlight,fullChartParams:e.fullChartParams})}),()=>{o.next(void 0),re.unsubscribe()}},U="BarStack",fe=se(U,oe)(({selection:i,name:l,subject:n,observer:s})=>{const m=new z,c=me(U,{selection:i,computedData$:s.computedData$,visibleComputedData$:s.visibleComputedData$,SeriesDataMap$:s.SeriesDataMap$,GroupDataMap$:s.GroupDataMap$,fullParams$:s.fullParams$,fullDataFormatter$:s.fullDataFormatter$,fullChartParams$:s.fullChartParams$,gridAxesTransform$:s.gridAxesTransform$,gridGraphicTransform$:s.gridGraphicTransform$,gridAxesSize$:s.gridAxesSize$,gridHighlight$:s.gridHighlight$,event$:n.event$});return()=>{m.next(void 0),c()}});export{fe as B};

import{g as N,S as L,t as T,m as R,d as v,e as S,s as P,p as A,q as k,r as E,c as W,u as z,x as H,w as U,z as q,O,A as _}from"./DNpuBO6_.js";import{b as F}from"./S8bNP8Tg.js";import{f as V}from"./Cz77Ev9R.js";function G(n,{text:s,radius:i,lineHeight:l,isBreakAll:o=!1,limit:u=0}){if(n==null||s==null){console.error("selection or text is not defined");return}i==null&&(i=n.node().getBBox().width/2);function r(a){let e;return o?e=a.split(""):e=a.split(/\s+/g),e[e.length-1]||e.pop(),e[0]||e.shift(),e}function p(a,e){return a&&e&&a.length>e&&(a=a.substring(0,e)+"..."),a}function f(a){var c;const e=document.createElement("canvas").getContext("2d");return((c=e==null?void 0:e.measureText(a))==null?void 0:c.width)??0}function b(a){const e=f(a.trim());return Math.sqrt(e*l)}function y(a,e){let c={width:0,text:""},g=1/0;const x=[];let D=" ";o&&(D="");for(let m=0,$=a.length;m<$;++m){const w=(c.text?c.text+D:"")+a[m],M=f(w);(g+M)/2<e?(c.width=g=M,c.text=w):(g=f(a[m]),c={width:g,text:a[m]},x.push(c))}return x}function t(a){let e=0;for(let c=0,g=a.length;c<g;++c){const x=(Math.abs(c-g/2+.5)+.5)*l,D=a[c].width/2;e=Math.max(e,Math.sqrt(D**2+x**2))}return e}function h(a,e){u>0&&(e=p(e,u));const c=r(e),g=b(e),x=y(c,g),D=t(x);let m=a.select("text");m.size()||(m=a.append("text")),m.attr("transform",`translate(0,0) scale(${i/D})`);const $=m.selectAll("tspan").data(x),w=$.enter().append("tspan").attr("x",0).merge($).attr("y",(M,C)=>(C-x.length/2+.8)*l).text(M=>M.text);return $.exit().remove(),$.merge(w)}return h(n,s)}let d;function J(n,s){return A().velocityDecay(s.force.velocityDecay).force("collision",k().radius(i=>i.r+s.force.collisionSpacing)).force("charge",E().strength(i=>-Math.pow(i.r,2)*s.force.strength)).on("tick",()=>{n.attr("transform",i=>`translate(${i.x},${i.y})`)})}function K({data:n,bubbleGroupR:s,maxValue:i,avgValue:l}){const o=s/Math.sqrt(n.length),r=o*o*Math.PI/l,p=i*r;return Math.pow(p/Math.PI,.5)*.75}function Q({data:n,LastBubbleDataMap:s,graphicWidth:i,graphicHeight:l,scaleType:o}){const u=Math.min(i,l)/2,r=n.flat().filter(a=>a.value!=null&&a.visible!=!1),p=Math.max(...r.map(a=>a.value)),f=r.reduce((a,e)=>a+(e.value??0),0)/r.length,b=K({data:r,bubbleGroupR:u,maxValue:p,avgValue:f}),y=o==="area"?.5:1,t=_().domain([0,p]).range([0,b]).exponent(y);return r.map(a=>{const e=a,c=s.get(a.id);c?(e.x=c.x,e.y=c.y):(e.x=Math.random()*i,e.y=Math.random()*l);const g=t(e.value??0);return e.r=g,e._originR=g,e})}function B({graphicSelection:n,bubblesData:s,fullParams:i}){let l=n.selectAll("g").data(s,r=>r.id),o=l.enter().append("g").attr("cursor","pointer");o.style("font-size",12).style("fill","#ffffff").attr("text-anchor","middle").attr("transform",r=>`translate(${r.x},${r.y})`),o.append("circle").attr("class","node").attr("cx",0).attr("cy",0).attr("fill",r=>r.color),o.append("text").style("opacity",.8).attr("pointer-events","none"),l.exit().remove();const u=l.merge(o);return u.select("circle").transition().duration(200).attr("r",r=>r.r).attr("fill",r=>r.color),u.each((r,p,f)=>{const b=W(f[p]);let y=!0;r.label.length<=i.bubbleText.lineLengthMin&&(y=!1),b.call(G,{text:r.label,radius:r.r*i.bubbleText.fillRate,lineHeight:i.bubbleText.lineHeight,isBreakAll:y})}),u}function X({data:n,highlightRIncrease:s,highlightIds:i}){if(s!=0){if(!i.length){n.forEach(l=>l.r=l._originR);return}n.forEach(l=>{i.includes(l.id)?l.r=l._originR+s:l.r=l._originR})}}function Y(){return z().on("start",(n,s)=>{n.active||d.alpha(1).restart(),s.fx=s.x,s.fy=s.y}).on("drag",(n,s)=>{n.active||d.alphaTarget(0),s.fx=n.x,s.fy=n.y}).on("end",(n,s)=>{s.fx=null,s.fy=null})}function I({fullParams:n,graphicWidth:s,graphicHeight:i}){d.force("x",H().strength(n.force.strength).x(0)).force("y",U().strength(n.force.strength).y(0)),d.alpha(1).restart()}function Z({bubblesSelection:n,highlightIds:s,fullChartParams:i}){if(n.interrupt("highlight"),!s.length){n.transition("highlight").style("opacity",1);return}n.each((l,o,u)=>{const r=W(u[o]);s.includes(l.id)?r.style("opacity",1).transition("highlight").ease(q).duration(500):r.style("opacity",i.styles.unhighlightedOpacity)})}const ae=N("Bubbles",F)(({selection:n,name:s,observer:i,subject:l})=>{const o=new L,u=n.append("g"),r=new L;let p=new Map;i.layout$.pipe(V()).subscribe(t=>{n.attr("transform",`translate(${t.width/2}, ${t.height/2})`),i.layout$.pipe(T(o)).subscribe(h=>{n.transition().attr("transform",`translate(${h.width/2}, ${h.height/2})`)})});const f=i.fullParams$.pipe(T(o),R(t=>t.bubbleScaleType),v()),b=new O(t=>{S({layout:i.layout$,computedData:i.computedData$,scaleType:f}).pipe(T(o),P(async h=>h)).subscribe(h=>{const a=Q({data:h.computedData,LastBubbleDataMap:p,graphicWidth:h.layout.width,graphicHeight:h.layout.height,scaleType:h.scaleType});t.next(a)})});b.subscribe(t=>{p=new Map(t.map(h=>[h.id,h]))});const y=i.fullChartParams$.pipe(T(o),R(t=>t.highlightTarget),v());return S({layout:i.layout$,computedData:i.computedData$,bubblesData:b,SeriesDataMap:i.SeriesDataMap$,fullParams:i.fullParams$,highlightTarget:y}).pipe(T(o),P(async t=>t)).subscribe(t=>{const h=B({graphicSelection:u,bubblesData:t.bubblesData,fullParams:t.fullParams});d=J(h,t.fullParams),h.on("mouseover",(a,e)=>{l.event$.next({type:"series",eventName:"mouseover",pluginName:s,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:a,data:t.computedData})}).on("mousemove",(a,e)=>{l.event$.next({type:"series",eventName:"mousemove",pluginName:s,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:a,data:t.computedData})}).on("mouseout",(a,e)=>{l.event$.next({type:"series",eventName:"mouseout",pluginName:s,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:a,data:t.computedData})}).on("click",(a,e)=>{l.event$.next({type:"series",eventName:"click",pluginName:s,highlightTarget:t.highlightTarget,datum:e,series:t.SeriesDataMap.get(e.seriesLabel),seriesIndex:e.seriesIndex,seriesLabel:e.seriesLabel,event:a,data:t.computedData})}).call(Y()),d.nodes(t.bubblesData),I({fullParams:t.fullParams,graphicWidth:t.layout.width,graphicHeight:t.layout.height}),r.next(h)}),S({bubblesSelection:r,bubblesData:b,highlight:i.seriesHighlight$,fullChartParams:i.fullChartParams$,fullParams:i.fullParams$,layout:i.layout$}).pipe(T(o),P(async t=>t)).subscribe(t=>{Z({bubblesSelection:t.bubblesSelection,highlightIds:t.highlight,fullChartParams:t.fullChartParams}),t.fullParams.highlightRIncrease&&(X({data:t.bubblesData,highlightRIncrease:t.fullParams.highlightRIncrease,highlightIds:t.highlight}),B({graphicSelection:u,bubblesData:t.bubblesData,fullParams:t.fullParams})),I({fullParams:t.fullParams,graphicWidth:t.layout.width,graphicHeight:t.layout.height}),d.nodes(t.bubblesData)}),()=>{o.next(void 0)}});export{ae as B};
